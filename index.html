<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å››å€‹æ°´æ‰‹è·¨å¹´åœ˜ðŸŒŠ (Phuket 2025)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .no-select { -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; }
        
        /* Glassmorphism utilities */
        .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        
        /* Floating Card Style during Drag */
        .floating-card {
            position: fixed;
            z-index: 9999;
            pointer-events: none;
            opacity: 0.95;
            transform: scale(1.05) rotate(-2deg);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7);
            width: 85%; 
            max-width: 400px;
            background: #0f172a; /* Slate 900 */
            border: 2px solid #3D9FBD;
            border-radius: 0.75rem;
            padding: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        /* The placeholder in the list where the item was */
        .drag-placeholder {
            opacity: 0.3;
            border: 2px dashed #64748b;
            filter: grayscale(100%);
        }

        /* Drop Zone Hint */
        .drop-zone-hint {
            height: 60px;
            margin: 8px 0;
            border: 2px dashed #34d399; /* Emerald */
            background-color: rgba(52, 211, 153, 0.15);
            border-radius: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #34d399;
            font-weight: bold;
            font-size: 0.875rem;
            letter-spacing: 0.05em;
            box-shadow: 0 0 15px rgba(52, 211, 153, 0.2);
            animation: pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        /* Prevent scrolling on the handle explicitly */
        .touch-none {
            touch-action: none !important;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
    </style>
</head>
<body class="bg-slate-950 text-slate-50 h-screen overflow-hidden">
    <div id="root" class="h-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- Icons ---
        const IconBase = ({ size = 16, className = "", children, ...props }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>
        );

        const Plane = (props) => <IconBase {...props}><path d="M2 12h20"/><path d="M13 2l9 10-9 10"/><path d="M2 12l5-5m0 10l-5-5"/></IconBase>;
        const Hotel = (props) => <IconBase {...props}><path d="M2 4v16"/><path d="M2 8h18a2 2 0 0 1 2 2v10"/><path d="M2 17h20"/><path d="M6 8v9"/></IconBase>;
        const Utensils = (props) => <IconBase {...props}><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"/></IconBase>;
        const MapPin = (props) => <IconBase {...props}><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></IconBase>;
        const Camera = (props) => <IconBase {...props}><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></IconBase>;
        const Sun = (props) => <IconBase {...props}><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41-1.41"/><path d="m19.07 4.93-1.41 1.41"/></IconBase>;
        const AlertTriangle = (props) => <IconBase {...props}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></IconBase>;
        const Plus = (props) => <IconBase {...props} strokeWidth="3"><path d="M5 12h14"/><path d="M12 5v14"/></IconBase>;
        const Trash2 = (props) => <IconBase {...props}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconBase>;
        const GripVertical = (props) => <IconBase {...props}><circle cx="9" cy="12" r="1"/><circle cx="9" cy="5" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="19" r="1"/></IconBase>;
        const Check = (props) => <IconBase {...props} strokeWidth="3"><polyline points="20 6 9 17 4 12"/></IconBase>;
        const Edit2 = (props) => <IconBase {...props}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></IconBase>;
        const MapIcon = (props) => <IconBase {...props}><polygon points="3 11 22 2 13 21 11 13 3 11"/><line x1="11" x2="13" y1="13" y2="21"/></IconBase>;
        const Cloud = (props) => <IconBase {...props}><path d="M17.5 19c0-1.7-1.3-3-3-3h-1.1c-.2-3.2-2.7-5.8-5.9-6-3.3.2-6 2.8-6.2 6.1H.5c-1.7 0-3 1.3-3 3s1.3 3 3 3h17c1.7 0 3-1.3 3-3z"/></IconBase>;
        const Search = (props) => <IconBase {...props}><circle cx="11" cy="11" r="8"/><line x1="21" x2="16.65" y1="21" y2="16.65"/></IconBase>;
        const X = (props) => <IconBase {...props}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></IconBase>;
        const ImageIcon = (props) => <IconBase {...props}><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></IconBase>;
        const ChevronUp = (props) => <IconBase {...props}><path d="m18 15-6-6-6 6"/></IconBase>;
        const FileText = (props) => <IconBase {...props}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></IconBase>;
        const ExternalLink = (props) => <IconBase {...props}><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></IconBase>;
        const Briefcase = (props) => <IconBase {...props}><rect width="20" height="14" x="2" y="7" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></IconBase>;
        const ArrowRightLeft = (props) => <IconBase {...props}><path d="m16 3 4 4-4 4"/><path d="M20 7H4"/><path d="m8 21-4-4 4-4"/><path d="M4 17h16"/></IconBase>;
        const Coins = (props) => <IconBase {...props}><circle cx="8" cy="8" r="6"/><path d="M18.09 10.37A6 6 0 1 1 10.34 18"/><path d="M7 6h1v4"/><path d="m16.71 13.88.7 .71-2.82 2.82"/></IconBase>;

        // --- Config ---
        const LOCAL_STORAGE_KEY = "phuket-trip-2025-user-data-v3";
        const CHECKLIST_STORAGE_KEY = "phuket-trip-checklist-v2";
        const PRIMARY_COLOR = "#3D9FBD";
        const TRIP_START_DATE = "2025-12-30";
        const DEFAULT_IMAGE = "https://images.unsplash.com/photo-1476514525535-07fb3b4ae5f1?auto=format&fit=crop&w=400&q=80";

        const DATE_TABS = [
            { label: "12/30 (Tue)", iso: "2025-12-30" },
            { label: "12/31 (Wed)", iso: "2025-12-31" },
            { label: "01/01 (Thu)", iso: "2026-01-01" },
            { label: "01/02 (Fri)", iso: "2026-01-02" },
            { label: "01/03 (Sat)", iso: "2026-01-03" },
            { label: "01/04 (Sun)", iso: "2026-01-04" },
        ];

        // NEW Initial Data based on User's Plan
        const INITIAL_EVENTS = [
            // Day 1: 12/30
            { id: "e1", date: "2025-12-30", time: "12:00", title: "æ¡ƒåœ’æ©Ÿå ´é›†åˆ (TPE)", type: "transport", location: "Taoyuan Airport", shortDescription: "æº–å‚™å‡ºç™¼ï¼è™Žèˆª IT 503ã€‚", imageUrl: "https://images.unsplash.com/photo-1542296332-2e44a99cfef0?auto=format&fit=crop&w=400&q=80" },
            { id: "e2", date: "2025-12-30", time: "14:00", title: "âœˆï¸ é£›æ©Ÿèµ·é£› IT 503", type: "transport", location: "TPE -> HKT", shortDescription: "é£›è¡Œæ™‚é–“ç´„ 4.5 å°æ™‚ã€‚", imageUrl: "https://images.unsplash.com/photo-1436491865332-7a61a109cc05?auto=format&fit=crop&w=400&q=80" },
            { id: "e3", date: "2025-12-30", time: "17:20", title: "æŠµé”æ™®å‰å³¶æ©Ÿå ´", type: "transport", location: "Phuket International Airport", shortDescription: "é€šé—œå…¥å¢ƒã€‚", imageUrl: "https://images.unsplash.com/photo-1530521954074-e64f6810b32d?auto=format&fit=crop&w=400&q=80" },
            { id: "e4", date: "2025-12-30", time: "18:00", title: "ç§Ÿè»Šå–è»Š (Drive Thailand)", type: "transport", location: "Airport Car Rental", shortDescription: "æª¢æŸ¥è»Šæ³ã€æ‹ç…§å­˜è­‰ã€‚", imageUrl: "https://images.unsplash.com/photo-1449965408869-eaa3f722e40d?auto=format&fit=crop&w=400&q=80" },
            { id: "e5", date: "2025-12-30", time: "19:00", title: "Check-in: Fusion Suites", type: "stay", location: "Fusion Suites Phuket Patong", shortDescription: "é£¯åº—A (Booking by æ°´æ°´)ã€‚ä¸‹è¡ŒæŽã€‚", imageUrl: "https://images.unsplash.com/photo-1566073771259-6a8506099945?auto=format&fit=crop&w=400&q=80" },
            { id: "e6", date: "2025-12-30", time: "20:00", title: "æ™šé¤ï¼šå…­è™Ÿé¤å»³ (No.6 Up The Hill)", type: "food", location: "No.6 Restaurant Up The Hill", shortDescription: "çŸ¥åæ³°å¼ç†±ç‚’ã€‚è‹¥ç¸½åº—å¤ªå¤šäººå¯åŽ»å±±ä¸Šåˆ†åº—ã€‚", imageUrl: "https://images.unsplash.com/photo-1559314809-0d155014e29e?auto=format&fit=crop&w=400&q=80", mapLink: "https://www.google.com/maps/place/No.6+Restaurant+Up+The+Hill/@7.9084315,98.3026681,17z/data=!3m1!4b1!4m6!3m5!1s0x30503b895aa9cead:0x429ddda6a910ac90!8m2!3d7.9084315!4d98.3072815!16s%2Fg%2F11kprrylg0?entry=ttu&g_ep=EgoyMDI1MTIwOS4wIKXMDSoASAFQAw%3D%3D" },
            { id: "e7", date: "2025-12-30", time: "21:00", title: "Bangla å¤œå¸‚ / æµ·ç˜æ•£æ­¥", type: "activity", location: "Bangla Road", shortDescription: "æ„Ÿå—æ™®å‰å³¶å¤œç”Ÿæ´»ã€‚", imageUrl: "https://images.unsplash.com/photo-1566737236500-c8ac43014a67?auto=format&fit=crop&w=400&q=80" },

            // Day 2: 12/31
            { id: "e8", date: "2025-12-31", time: "08:30", title: "é£¯åº—æ—©é¤", type: "food", location: "Fusion Suites", shortDescription: "", imageUrl: "https://images.unsplash.com/photo-1533001217742-1e9680c2e64d?auto=format&fit=crop&w=400&q=80" },
            { id: "e9", date: "2025-12-31", time: "10:30", title: "é£¯åº—æ³³æ± çŽ©æ°´", type: "activity", location: "Hotel Pool", shortDescription: "æ¸¸æ¸¸æ¸¸ã€‚", imageUrl: "https://images.unsplash.com/photo-1576013551627-0cc20b96c2a7?auto=format&fit=crop&w=400&q=80" },
            { id: "e10", date: "2025-12-31", time: "11:00", title: "å¤§è±¡ä¿è­·å€", type: "activity", location: "Elephant Sanctuary", shortDescription: "èˆ‡å¤§è±¡äº’å‹•ã€‚", imageUrl: "https://images.unsplash.com/photo-1585970480901-90d63348d801?auto=format&fit=crop&w=400&q=80" },
            { id: "e11", date: "2025-12-31", time: "13:00", title: "åˆé¤: Sugar and Spice", type: "food", location: "Sugar and Spice Restaurant", shortDescription: "æ³°å¼/è¥¿å¼æ–™ç†ã€‚", imageUrl: "https://images.unsplash.com/photo-1504674900247-0877df9cc836?auto=format&fit=crop&w=400&q=80" },
            { id: "e12", date: "2025-12-31", time: "15:00", title: "å±±å¡ç¶²ç¾Žå’–å•¡", type: "food", location: "Phuket Hillside Cafe", shortDescription: "âš ï¸ æ³¨æ„ï¼šè·¨å¹´å¤œå·´æ±å¯èƒ½ææ—©å°è·¯ï¼Œå»ºè­°ææ—©å›žç¨‹ã€‚", imageUrl: "https://images.unsplash.com/photo-1554118811-1e0d58224f24?auto=format&fit=crop&w=400&q=80" },
            { id: "e13", date: "2025-12-31", time: "16:00", title: "æµ·é‚Šç¶²ç¾Žå’–å•¡", type: "food", location: "Seaside Cafe", shortDescription: "çœ‹æµ·æ™¯ã€‚", imageUrl: "https://images.unsplash.com/photo-1520250497591-112f2f40a3f4?auto=format&fit=crop&w=400&q=80" },
            { id: "e14", date: "2025-12-31", time: "18:00", title: "æ™®å‰å³¶æœ€é«˜è§€æ™¯é»ž", type: "activity", location: "Karon Viewpoint", shortDescription: "æ¬£è³žå¤•é™½ã€‚âš ï¸ è¶•å¿«å›žå·´æ±åœè»Šï¼", imageUrl: "https://images.unsplash.com/photo-1536098561742-ca998e48cbcc?auto=format&fit=crop&w=400&q=80" },
            { id: "e15", date: "2025-12-31", time: "19:00", title: "å›žé£¯åº—æ¢³æ´—", type: "stay", location: "Fusion Suites", shortDescription: "æº–å‚™è·¨å¹´ã€‚", imageUrl: "https://images.unsplash.com/photo-1571003123894-1f0594d2b5d9?auto=format&fit=crop&w=400&q=80" },
            { id: "e16", date: "2025-12-31", time: "20:00", title: "å·´æ±è¡—æ™šé¤ã€å–é…’", type: "party", location: "Patong Street", shortDescription: "è·¨å¹´æ°£æ°›ã€‚", imageUrl: "https://images.unsplash.com/photo-1574345568972-e5658d533b8a?auto=format&fit=crop&w=400&q=80" },
            { id: "e17", date: "2025-12-31", time: "23:00", title: "è·¨å¹´ç…™ç«ç§€ ðŸŽ†", type: "party", location: "Patong Beach", shortDescription: "Happy New Year!", imageUrl: "https://images.unsplash.com/photo-1467810563316-b5476525c0f9?auto=format&fit=crop&w=400&q=80" },

            // Day 3: 01/01
            { id: "e18", date: "2026-01-01", time: "08:00", title: "é£¯åº—æ—©é¤", type: "food", location: "Fusion Suites", shortDescription: "", imageUrl: "https://images.unsplash.com/photo-1493770348161-369560ae357d?auto=format&fit=crop&w=400&q=80" },
            { id: "e19", date: "2026-01-01", time: "09:00", title: "Freedom Beach", type: "activity", location: "Freedom Beach", shortDescription: "æ­èˆ¹æˆ–çˆ¬å±±è·¯åŽ»ã€‚", imageUrl: "https://images.unsplash.com/photo-1589394815804-964ed0be2eb5?auto=format&fit=crop&w=400&q=80" },
            { id: "e20", date: "2026-01-01", time: "10:00", title: "Tri Trang Beach", type: "activity", location: "Tri Trang Beach", shortDescription: "", imageUrl: "https://images.unsplash.com/photo-1507525428034-b723cf961d3e?auto=format&fit=crop&w=400&q=80" },
            { id: "e21", date: "2026-01-01", time: "11:00", title: "ç¥žç´šé›žè‚‰é£¯", type: "food", location: "Briley Chicken Rice", shortDescription: "å¿…åƒæµ·å—é›žé£¯ã€‚", imageUrl: "https://images.unsplash.com/photo-1534422298391-e4f8c172dddb?auto=format&fit=crop&w=400&q=80" },
            { id: "e22", date: "2026-01-01", time: "12:00", title: "Check-in: Seabed Grand", type: "stay", location: "Seabed Grand Hotel Phuket", shortDescription: "æ›é£¯åº— (Booking by hoho)ã€‚ç§»å‹•åˆ°æ™®å‰éŽ®æ–¹å‘ã€‚", imageUrl: "https://images.unsplash.com/photo-1618773928121-c32242e63f39?auto=format&fit=crop&w=400&q=80" },
            { id: "e23", date: "2026-01-01", time: "13:00", title: "Hanuman World æ£®æž—æºœç´¢", type: "activity", location: "Hanuman World", shortDescription: "åˆºæ¿€å¢æž—é£›èºã€‚", imageUrl: "https://images.unsplash.com/photo-1596395819057-d377484a0d9a?auto=format&fit=crop&w=400&q=80" },
            { id: "e24", date: "2026-01-01", time: "14:00", title: "æ™®å‰éŽ®è€è¡—", type: "activity", location: "Old Town Phuket", shortDescription: "ä¸­è‘¡å¼å»ºç¯‰æ‹ç…§ã€‚", imageUrl: "https://images.unsplash.com/photo-1605707733671-59727409249e?auto=format&fit=crop&w=400&q=80" },
            { id: "e25", date: "2026-01-01", time: "15:00", title: "Phuketique æ³•å¼åå¸", type: "food", location: "Phuketique", shortDescription: "çˆ†å¹¹å¥½åƒä½†è¦æŽ’éšŠã€‚", imageUrl: "https://images.unsplash.com/photo-1484723091739-30a097e8f929?auto=format&fit=crop&w=400&q=80" },
            { id: "e26", date: "2026-01-01", time: "18:00", title: "å¿…æ¯”ç™»: One Chun Cafe", type: "food", location: "One Chun Cafe", shortDescription: "ç±³å…¶æž—æŽ¨è–¦æ³°å—èœã€‚", imageUrl: "https://images.unsplash.com/photo-1563897539633-7374c278c224?auto=format&fit=crop&w=400&q=80" },
            { id: "e27", date: "2026-01-01", time: "20:00", title: "G Market å¤œå¸‚å¸‚é›†", type: "food", location: "G Market", shortDescription: "Phuket Grocery æ—çš„æ–°å¤œå¸‚ã€‚", imageUrl: "https://images.unsplash.com/photo-1534438097545-a2c22c57f271?auto=format&fit=crop&w=400&q=80" },

            // Day 4: 01/02
            { id: "e28", date: "2026-01-02", time: "09:00", title: "è·³å³¶ï¼šçš®çš®å³¶ä¸€æ—¥éŠ", type: "activity", location: "Boat Ramp Pier", shortDescription: "12/24å‰éœ€é ç´„ (çŽ„ä¸¸ä¸‹è¨‚)ã€‚", imageUrl: "https://images.unsplash.com/photo-1537956965359-35780d64d509?auto=format&fit=crop&w=400&q=80" },
            { id: "e29", date: "2026-01-02", time: "12:00", title: "è·³å³¶åˆé¤", type: "food", location: "Phi Phi Island", shortDescription: "è¡Œç¨‹åŒ…å«ã€‚", imageUrl: "https://images.unsplash.com/photo-1559304822-9eb2813c9844?auto=format&fit=crop&w=400&q=80" },
            { id: "e30", date: "2026-01-02", time: "17:00", title: "å›žåˆ°æœ¬å³¶ç¢¼é ­", type: "transport", location: "Pier", shortDescription: "è¿”å›žé£¯åº—æ¢³æ´—ã€‚", imageUrl: "https://images.unsplash.com/photo-1581452417769-653a0670c538?auto=format&fit=crop&w=400&q=80" },
            { id: "e31", date: "2026-01-02", time: "18:00", title: "Chillva Market (é’è›™å¤œå¸‚)", type: "food", location: "Chillva Market", shortDescription: "æ–‡é’å¤œå¸‚ï¼Œæ°£æ°›å¥½ã€‚", imageUrl: "https://images.unsplash.com/photo-1555685812-4b943f1cb0eb?auto=format&fit=crop&w=400&q=80" },
            { id: "e32", date: "2026-01-02", time: "20:00", title: "Big C æŽ¡è²·", type: "activity", location: "Big C Supercenter", shortDescription: "è²·ä¼´æ‰‹ç¦®ã€‚", imageUrl: "https://images.unsplash.com/photo-1580913428739-c2ae9b039556?auto=format&fit=crop&w=400&q=80" },

            // Day 5: 01/03
            { id: "e33", date: "2026-01-03", time: "10:00", title: "é£¯åº—çˆ½å»¢", type: "stay", location: "Seabed Grand", shortDescription: "æœ€å¾Œäº«å—é£¯åº—è¨­æ–½ã€‚", imageUrl: "https://images.unsplash.com/photo-1566073771259-6a8506099945?auto=format&fit=crop&w=400&q=80" },
            { id: "e34", date: "2026-01-03", time: "11:00", title: "æµ·ç˜èººè‘—", type: "activity", location: "Beach", shortDescription: "æœ€å¾Œçš„æµ·ç˜æ™‚å…‰ã€‚", imageUrl: "https://images.unsplash.com/photo-1507525428034-b723cf961d3e?auto=format&fit=crop&w=400&q=80" },
            { id: "e35", date: "2026-01-03", time: "16:00", title: "Ma Doo Bua è“®èŠ±æ± å’–å•¡", type: "food", location: "Ma Doo Bua", shortDescription: "ç¶²ç¾Žå¿…æ‹ï¼Œé›¢æ©Ÿå ´è¿‘ã€‚", imageUrl: "https://images.unsplash.com/photo-1528163939626-d5d1c5d00fc6?auto=format&fit=crop&w=400&q=80" },
            { id: "e36", date: "2026-01-03", time: "18:00", title: "é‚„è»Š", type: "transport", location: "Airport Car Rental", shortDescription: "é ç•™æ™‚é–“æª¢æŸ¥ã€‚", imageUrl: "https://images.unsplash.com/photo-1449965408869-eaa3f722e40d?auto=format&fit=crop&w=400&q=80" },
            { id: "e37", date: "2026-01-03", time: "19:00", title: "æ™®å‰å³¶æ©Ÿå ´ Check-in", type: "transport", location: "Phuket Airport", shortDescription: "âš ï¸ å»ºè­°ææ—©ã€‚äººå¤šã€‚", imageUrl: "https://images.unsplash.com/photo-1530521954074-e64f6810b32d?auto=format&fit=crop&w=400&q=80" },
            { id: "e38", date: "2026-01-03", time: "20:45", title: "âœˆï¸ é£›æ©Ÿèµ·é£› IT 504", type: "transport", location: "HKT -> TPE", shortDescription: "Bye Phuket!", imageUrl: "https://images.unsplash.com/photo-1436491865332-7a61a109cc05?auto=format&fit=crop&w=400&q=80" },
            
            // Day 6: 01/04
            { id: "e39", date: "2026-01-04", time: "01:35", title: "æŠµé”æ¡ƒåœ’æ©Ÿå ´", type: "transport", location: "TPE", shortDescription: "ç”œèœœçš„å®¶ã€‚", imageUrl: "https://images.unsplash.com/photo-1542296332-2e44a99cfef0?auto=format&fit=crop&w=400&q=80" },
        ];

        // --- Highlight Text ---
        const HighlightText = ({ text, highlight, className = "" }) => {
            if (!highlight || !highlight.trim() || !text) return <span className={className}>{text}</span>;
            const parts = text.toString().split(new RegExp(`(${highlight})`, 'gi'));
            return (
                <span className={className}>
                    {parts.map((part, i) =>
                        part.toLowerCase() === highlight.toLowerCase()
                            ? <span key={i} className="bg-yellow-500/30 text-yellow-200 rounded px-0.5">{part}</span>
                            : part
            )}
                </span>
            );
        };

        // --- Docs View Component ---
        const DocsView = () => {
            const [checklist, setChecklist] = useState(() => {
                const saved = localStorage.getItem(CHECKLIST_STORAGE_KEY);
                return saved ? JSON.parse(saved) : [
                    { id: "c1", label: "Passport (Validity > 6 months)", checked: false },
                    { id: "c2", label: "TDAC Digital Arrival Card (QR Code)", checked: false },
                    { id: "c3", label: "Return Flight Ticket", checked: false },
                    { id: "c4", label: "Hotel Vouchers / Booking", checked: false },
                    { id: "c5", label: "Travel Insurance (Recommended)", checked: false },
                    { id: "c6", label: "Exchange Thai Baht (Cash)", checked: false },
                    { id: "c7", label: "SIM Card / Roaming", checked: false },
                ];
            });

            const [newItemText, setNewItemText] = useState("");
            
            // Currency Converter State
            const [amount, setAmount] = useState(100);
            const [direction, setDirection] = useState("THB_TO_TWD"); // "THB_TO_TWD" or "TWD_TO_THB"
            const [exchangeRate, setExchangeRate] = useState(0.92); // Fallback: 1 THB = 0.92 TWD
            const [isLoadingRate, setIsLoadingRate] = useState(false);
            const [lastUpdated, setLastUpdated] = useState(null);

            useEffect(() => {
                localStorage.setItem(CHECKLIST_STORAGE_KEY, JSON.stringify(checklist));
            }, [checklist]);

            // Fetch Real-time Rates
            useEffect(() => {
                setIsLoadingRate(true);
                fetch('https://api.exchangerate-api.com/v4/latest/THB')
                    .then(res => res.json())
                    .then(data => {
                        if(data.rates && data.rates.TWD) {
                            setExchangeRate(data.rates.TWD);
                            setLastUpdated(new Date().toLocaleTimeString());
                        }
                        setIsLoadingRate(false);
                    })
                    .catch(err => {
                        console.warn("Rate fetch failed, using fallback", err);
                        setIsLoadingRate(false);
                    });
            }, []);

            const toggleCheck = (id) => {
                setChecklist(prev => prev.map(item => item.id === id ? { ...item, checked: !item.checked } : item));
            };

            const handleAddChecklist = (e) => {
                e.preventDefault();
                if(!newItemText.trim()) return;
                setChecklist(prev => [...prev, { id: `c-${Date.now()}`, label: newItemText, checked: false }]);
                setNewItemText("");
            };

            const handleDeleteChecklist = (id) => {
                if(confirm("Remove this item?")) {
                    setChecklist(prev => prev.filter(i => i.id !== id));
                }
            };

            const convertedResult = useMemo(() => {
                const val = parseFloat(amount) || 0;
                if (direction === "THB_TO_TWD") {
                    return (val * exchangeRate).toFixed(1);
                } else {
                    return (val / exchangeRate).toFixed(1);
                }
            }, [amount, direction, exchangeRate]);

            return (
                <div className="space-y-4 animate-in fade-in slide-in-from-bottom-4 duration-500 pb-20">
                    {/* Currency Converter */}
                    <div className="bg-gradient-to-br from-emerald-900/80 to-slate-900 border border-emerald-500/50 rounded-2xl p-5 shadow-lg relative overflow-hidden">
                        <div className="absolute -right-6 -top-6 opacity-10 text-emerald-300"><Coins size={120} /></div>
                        
                        <div className="flex justify-between items-start mb-4 relative z-10">
                            <h2 className="text-lg font-bold text-emerald-100 flex items-center gap-2">
                                <Coins size={20} className="text-emerald-400"/> Rate Converter
                            </h2>
                            <div className="text-[10px] text-emerald-400/70 text-right">
                                {isLoadingRate ? "Updating..." : (lastUpdated ? `Updated: ${lastUpdated}` : "Est. Rate")}
                                <div className="font-mono">1 THB â‰ˆ {exchangeRate.toFixed(3)} TWD</div>
                            </div>
                        </div>

                        <div className="flex flex-col gap-4 relative z-10">
                            <div className="flex items-center gap-3 bg-slate-900/50 p-1 rounded-xl border border-emerald-500/30">
                                <div className="flex-1 text-center py-2 px-3 rounded-lg font-bold text-sm transition-colors text-white bg-emerald-600 shadow-sm">
                                    {direction === "THB_TO_TWD" ? "ðŸ‡¹ðŸ‡­ THB" : "ðŸ‡¹ðŸ‡¼ TWD"}
                                </div>
                                <button 
                                    onClick={() => setDirection(prev => prev === "THB_TO_TWD" ? "TWD_TO_THB" : "THB_TO_TWD")}
                                    className="p-2 rounded-full hover:bg-white/10 text-emerald-300 active:scale-90 transition-transform"
                                >
                                    <ArrowRightLeft size={18} />
                                </button>
                                <div className="flex-1 text-center py-2 px-3 rounded-lg font-bold text-sm transition-colors text-emerald-100/50">
                                    {direction === "THB_TO_TWD" ? "ðŸ‡¹ðŸ‡¼ TWD" : "ðŸ‡¹ðŸ‡­ THB"}
                                </div>
                            </div>

                            <div className="flex items-end gap-3">
                                <div className="flex-1">
                                    <label className="text-xs text-emerald-400/70 ml-1 mb-1 block">Amount</label>
                                    <input 
                                        type="number" 
                                        value={amount} 
                                        onChange={(e) => setAmount(e.target.value)}
                                        className="w-full bg-slate-900/80 border border-emerald-500/30 rounded-xl px-4 py-3 text-xl font-mono text-white focus:outline-none focus:border-emerald-400"
                                    />
                                </div>
                                <div className="pb-3 text-emerald-500 font-bold text-xl">=</div>
                                <div className="flex-1">
                                    <label className="text-xs text-emerald-400/70 ml-1 mb-1 block">Result</label>
                                    <div className="w-full bg-emerald-900/30 border border-emerald-500/30 rounded-xl px-4 py-3 text-xl font-mono text-emerald-200 text-right overflow-hidden text-ellipsis">
                                        {convertedResult}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Important Alert Card (TDAC) */}
                    <div className="glass-panel rounded-2xl p-4 shadow-lg flex items-start gap-3">
                        <div className="bg-indigo-500/20 p-2 rounded-lg text-indigo-300 shrink-0 mt-1"><Briefcase size={20}/></div>
                        <div>
                            <h3 className="font-bold text-indigo-200 text-sm">Digital Arrival Card (TDAC)</h3>
                            <p className="text-xs text-slate-400 mt-1 mb-2">Mandatory for all visitors. Submit online within 3 days before arrival.</p>
                            <a href="https://tdac.immigration.go.th" target="_blank" className="text-xs bg-indigo-600 hover:bg-indigo-500 text-white px-3 py-1.5 rounded-md inline-flex items-center gap-1 transition-colors">
                                Open TDAC Website <ExternalLink size={10} />
                            </a>
                        </div>
                    </div>

                    {/* Editable Checklist */}
                    <div className="glass-panel rounded-2xl p-5 shadow-lg">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="font-bold text-slate-200 flex items-center gap-2"><Check size={18} className="text-emerald-400"/> Trip Checklist</h3>
                            <span className="text-xs bg-slate-800 px-2 py-1 rounded text-slate-400 font-mono">{checklist.filter(i=>i.checked).length}/{checklist.length}</span>
                        </div>
                        
                        <div className="space-y-2 mb-4">
                            {checklist.map(item => (
                                <div key={item.id} className="flex items-center gap-3 p-2 hover:bg-slate-800/50 rounded-lg group transition-colors">
                                    <div 
                                        onClick={() => toggleCheck(item.id)}
                                        className={`w-5 h-5 rounded border flex items-center justify-center shrink-0 cursor-pointer transition-all ${item.checked ? "bg-emerald-500 border-emerald-500" : "border-slate-600 hover:border-emerald-400"}`}
                                    >
                                        {item.checked && <Check size={12} className="text-white" />}
                                    </div>
                                    <span 
                                        onClick={() => toggleCheck(item.id)}
                                        className={`text-sm flex-1 cursor-pointer select-none ${item.checked ? "text-slate-500 line-through" : "text-slate-300"}`}
                                    >
                                        {item.label}
                                    </span>
                                    <button 
                                        onClick={() => handleDeleteChecklist(item.id)}
                                        className="text-slate-600 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity p-1"
                                    >
                                        <Trash2 size={14} />
                                    </button>
                                </div>
                            ))}
                        </div>

                        <form onSubmit={handleAddChecklist} className="flex gap-2 border-t border-slate-700/50 pt-4">
                            <input 
                                type="text" 
                                value={newItemText} 
                                onChange={(e) => setNewItemText(e.target.value)}
                                placeholder="Add new item..." 
                                className="flex-1 bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-xs text-white focus:outline-none focus:border-emerald-500 transition-colors"
                            />
                            <button type="submit" disabled={!newItemText.trim()} className="bg-emerald-600 hover:bg-emerald-500 disabled:opacity-50 disabled:cursor-not-allowed text-white rounded-lg px-3 py-2 transition-colors">
                                <Plus size={16} />
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        const PhuketTripApp = () => {
            const [view, setView] = useState('itinerary'); // 'itinerary' | 'docs'
            
            // Auto-detect date on load
            const [selectedDate, setSelectedDate] = useState(() => {
                const d = new Date();
                const todayIso = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
                const found = DATE_TABS.find(t => t.iso === todayIso);
                return found ? found.iso : DATE_TABS[0].iso;
            });

            const [expandedEventId, setExpandedEventId] = useState(null);
            const [events, setEvents] = useState([]);
            const [editingId, setEditingId] = useState(null);
            const [processingImage, setProcessingImage] = useState(false);
            const [isSaved, setIsSaved] = useState(true);
            const [searchQuery, setSearchQuery] = useState("");

            // --- Custom Long Press & Drag State ---
            const [dragState, setDragState] = useState({
                isDragging: false,
                draggedId: null,
                initialY: 0,
                currentY: 0,
                currentX: 0,
                dropIndex: -1
            });
            const longPressTimer = useRef(null);
            const listRef = useRef(null); // Reference to the event list container

            // --- Countdown ---
            const daysToGo = useMemo(() => {
                const start = new Date(TRIP_START_DATE);
                const today = new Date();
                const diffTime = start - today;
                return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            }, []);

            const countdownText = daysToGo > 0
                ? `${daysToGo} Days to Go`
                : (daysToGo === 0 ? "Trip is Today!" : `Day ${Math.abs(daysToGo) + 1} of Trip`);

            // --- Persistence ---
            useEffect(() => {
                try {
                    const raw = localStorage.getItem(LOCAL_STORAGE_KEY);
                    setEvents(raw ? JSON.parse(raw) : INITIAL_EVENTS);
                } catch (e) { setEvents(INITIAL_EVENTS); }
            }, []);

            useEffect(() => {
                if (events.length > 0) {
                    try {
                        localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(events));
                        setIsSaved(true);
                        const timer = setTimeout(() => setIsSaved(false), 2000);
                        return () => clearTimeout(timer);
                    } catch (e) { console.error("Storage full", e); }
                }
            }, [events]);

            const now = new Date();

            // --- Logic ---
            const eventsForSelectedDate = useMemo(() => {
                let filtered = events.filter(e => e.date === selectedDate);
                if (searchQuery.trim()) {
                    const q = searchQuery.toLowerCase();
                    filtered = filtered.filter(e =>
                        (e.title && e.title.toLowerCase().includes(q)) ||
                        (e.location && e.location.toLowerCase().includes(q)) ||
                        (e.shortDescription && e.shortDescription.toLowerCase().includes(q)) ||
                        (e.userNotes && e.userNotes.toLowerCase().includes(q))
                    );
                }
                return filtered.sort((a, b) => a.time.localeCompare(b.time));
            }, [events, selectedDate, searchQuery]);

            const handleToggleChecked = (id) => setEvents(prev => prev.map(ev => ev.id === id ? { ...ev, isCompleted: !ev.isCompleted } : ev));
            const handleNoteChange = (id, text) => setEvents(prev => prev.map(ev => ev.id === id ? { ...ev, userNotes: text } : ev));
            const handleDeleteEvent = (id) => { if(confirm("Delete this event?")) setEvents(prev => prev.filter(ev => ev.id !== id)); };
            const handleUpdateField = (id, field, value) => { setEvents(prev => prev.map(ev => ev.id === id ? { ...ev, [field]: value } : ev)); };

            const handleOpenMap = (location, title, mapLink) => {
                if (mapLink) {
                    window.open(mapLink, '_blank');
                    return;
                }
                const query = encodeURIComponent(`${location} ${title || ''}`);
                window.open(`https://www.google.com/maps/search/?api=1&query=${query}`, '_blank');
            };

            // --- GLOBAL DRAG EVENTS (Attached to Window) ---
            useEffect(() => {
                const handleGlobalMove = (e) => {
                    if (!dragState.isDragging) return;
                    e.preventDefault(); // Stop scrolling!
                    
                    const touch = e.touches ? e.touches[0] : e;
                    const y = touch.clientY;
                    const x = touch.clientX;

                    // Calculate Drop Index
                    let newDropIndex = -1;
                    if (listRef.current) {
                        const items = Array.from(listRef.current.children).filter(el => el.getAttribute('data-event-card') === 'true');
                        newDropIndex = items.length; // Default to end

                        for (let i = 0; i < items.length; i++) {
                            const rect = items[i].getBoundingClientRect();
                            const middle = rect.top + rect.height / 2;
                            if (y < middle) {
                                newDropIndex = i;
                                break;
                            }
                        }
                    }

                    setDragState(prev => ({
                        ...prev,
                        currentY: y,
                        currentX: x,
                        dropIndex: newDropIndex
                    }));
                };

                const handleGlobalEnd = (e) => {
                    if (!dragState.isDragging) return;
                    e.preventDefault();

                    const { draggedId, dropIndex } = dragState;
                    
                    if (draggedId && dropIndex !== -1) {
                        // perform drop logic (same as before)
                        const currentList = eventsForSelectedDate;
                        const fromIndex = currentList.findIndex(ev => ev.id === draggedId);
                        
                        if (fromIndex !== -1) {
                            let finalDropIndex = dropIndex;
                            if (fromIndex < dropIndex) finalDropIndex -= 1;

                            // Reorder and Time Logic
                            const tempList = [...currentList];
                            const [movedItem] = tempList.splice(fromIndex, 1);
                            tempList.splice(finalDropIndex, 0, movedItem);

                            const prevItem = finalDropIndex > 0 ? tempList[finalDropIndex - 1] : null;
                            const nextItem = finalDropIndex < tempList.length - 1 ? tempList[finalDropIndex + 1] : null;

                            let newTimeStr = movedItem.time;
                            const timeToMin = (t) => {
                                const [h, m] = t.split(':').map(Number);
                                return h * 60 + m;
                            };
                            const minToTime = (m) => {
                                let h = Math.floor(m / 60);
                                let min = Math.floor(m % 60);
                                if (h < 0) h = 0; if (h > 23) h = 23;
                                return `${h.toString().padStart(2, '0')}:${min.toString().padStart(2, '0')}`;
                            };

                            if (prevItem && nextItem) {
                                const t1 = timeToMin(prevItem.time);
                                const t2 = timeToMin(nextItem.time);
                                let mid = (t1 + t2) / 2;
                                let roundedMid = Math.round(mid / 30) * 30;
                                if (roundedMid > t1 && roundedMid < t2) {
                                    newTimeStr = minToTime(roundedMid);
                                } else {
                                    newTimeStr = minToTime(Math.floor(mid));
                                }
                            } else if (prevItem) {
                                newTimeStr = minToTime(timeToMin(prevItem.time) + 30);
                            } else if (nextItem) {
                                newTimeStr = minToTime(timeToMin(nextItem.time) - 30);
                            }

                            const updatedEvent = { ...movedItem, time: newTimeStr };
                            setEvents(prev => prev.map(ev => ev.id === draggedId ? updatedEvent : ev));
                        }
                    }

                    // Reset
                    setDragState({ isDragging: false, draggedId: null, initialY: 0, currentY: 0, currentX: 0, dropIndex: -1 });
                };

                if (dragState.isDragging) {
                    // Attach non-passive listeners to block scrolling
                    window.addEventListener('touchmove', handleGlobalMove, { passive: false });
                    window.addEventListener('touchend', handleGlobalEnd, { passive: false });
                    window.addEventListener('mousemove', handleGlobalMove, { passive: false }); // For testing on desktop
                    window.addEventListener('mouseup', handleGlobalEnd, { passive: false });
                }

                return () => {
                    window.removeEventListener('touchmove', handleGlobalMove);
                    window.removeEventListener('touchend', handleGlobalEnd);
                    window.removeEventListener('mousemove', handleGlobalMove);
                    window.removeEventListener('mouseup', handleGlobalEnd);
                };
            }, [dragState.isDragging, eventsForSelectedDate]);


            // --- Start Handler ---
            const handleTouchStart = (e, id) => {
                if (searchQuery) return;
                
                // Allow scrolling initially
                const touch = e.touches ? e.touches[0] : e;
                const startY = touch.clientY;
                const startX = touch.clientX;

                longPressTimer.current = setTimeout(() => {
                    // Trigger Drag Mode
                    if (window.navigator && window.navigator.vibrate) {
                        window.navigator.vibrate(50);
                    }
                    setDragState({
                        isDragging: true,
                        draggedId: id,
                        initialY: startY,
                        currentY: startY,
                        currentX: startX,
                        dropIndex: -1
                    });
                }, 600); // 600ms long press
            };

            const handleTouchEndCleanup = () => {
                if (longPressTimer.current) {
                    clearTimeout(longPressTimer.current);
                    longPressTimer.current = null;
                }
            };

            // Image Upload Handlers
            const handleImageUpload = (id, e) => {
                const file = e.target.files[0];
                if (!file) return;
                setProcessingImage(true);
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const MAX_WIDTH = 800; const MAX_HEIGHT = 800;
                        let width = img.width; let height = img.height;
                        if (width > height) { if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; } }
                        else { if (height > MAX_HEIGHT) { width *= MAX_HEIGHT / height; height = MAX_HEIGHT; } }
                        canvas.width = width; canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        const compressedBase64 = canvas.toDataURL('image/jpeg', 0.7);
                        setEvents(prev => prev.map(ev => ev.id === id ? { ...ev, images: [...(ev.images || []), compressedBase64] } : ev));
                        setProcessingImage(false);
                    };
                };
            };

            const handleCoverUpload = (id, e) => {
                const file = e.target.files[0];
                if (!file) return;
                setProcessingImage(true);
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const MAX_WIDTH = 800; const MAX_HEIGHT = 800;
                        let width = img.width; let height = img.height;
                        if (width > height) { if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; } }
                        else { if (height > MAX_HEIGHT) { width *= MAX_HEIGHT / height; height = MAX_HEIGHT; } }
                        canvas.width = width; canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        const compressedBase64 = canvas.toDataURL('image/jpeg', 0.7);
                        setEvents(prev => prev.map(ev => ev.id === id ? { ...ev, imageUrl: compressedBase64 } : ev));
                        setProcessingImage(false);
                    };
                };
            };

            // Add Event Logic
            const handleAddEvent = (indexToInsert = -1) => {
                const newId = `new-${Date.now()}`;
                let smartTime = "12:00";
                const currentDayEvents = events.filter(e => e.date === selectedDate).sort((a, b) => a.time.localeCompare(b.time));

                if (currentDayEvents.length > 0) {
                    if (indexToInsert === 0) {
                        const [h, m] = currentDayEvents[0].time.split(':').map(Number);
                        const newH = Math.max(0, h - 1);
                        smartTime = `${newH.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
                    } else if (indexToInsert >= currentDayEvents.length) {
                        const [h, m] = currentDayEvents[currentDayEvents.length - 1].time.split(':').map(Number);
                        const newH = Math.min(23, h + 1);
                        smartTime = `${newH.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
                    } else if (indexToInsert > 0) {
                        const [h1, m1] = currentDayEvents[indexToInsert - 1].time.split(':').map(Number);
                        const [h2, m2] = currentDayEvents[indexToInsert].time.split(':').map(Number);
                        const tMid = Math.floor(((h1 * 60 + m1) + (h2 * 60 + m2)) / 2);
                        smartTime = `${Math.floor(tMid / 60).toString().padStart(2, '0')}:${(tMid % 60).toString().padStart(2, '0')}`;
                    }
                } else { smartTime = "09:00"; }

                const newEvent = { id: newId, date: selectedDate, time: smartTime, title: "", type: "activity", location: "", shortDescription: "New Item", isCompleted: false, images: [] };
                setEvents(prev => [...prev, newEvent]);
                setEditingId(newId);
                if (searchQuery) setSearchQuery("");
            };

            const getCategoryIcon = (type) => {
                switch(type) {
                    case 'transport': return <Plane className="text-blue-400" />;
                    case 'food': return <Utensils className="text-orange-400" />;
                    case 'stay': return <Hotel className="text-purple-400" />;
                    case 'activity': return <Camera className="text-emerald-400" />;
                    case 'warning': return <AlertTriangle className="text-red-400" />;
                    case 'party': return <Sun className="text-pink-400" />;
                    default: return <MapPin className="text-slate-400" />;
                }
            };

            const typeLabels = { transport: "äº¤é€š", activity: "è¡Œç¨‹", food: "ç¾Žé£Ÿ", stay: "ä½å®¿", warning: "æ³¨æ„", party: "æ´¾å°" };

            // Helper for Highlight
            const HighlightText = ({ text, highlight, className = "" }) => {
                if (!highlight || !highlight.trim() || !text) return <span className={className}>{text}</span>;
                const parts = text.toString().split(new RegExp(`(${highlight})`, 'gi'));
                return (
                    <span className={className}>
                        {parts.map((part, i) =>
                            part.toLowerCase() === highlight.toLowerCase()
                                ? <span key={i} className="bg-yellow-500/30 text-yellow-200 rounded px-0.5">{part}</span>
                                : part
                )}
                    </span>
                );
            };

            const AddZone = ({ index }) => (
                <div className="h-2 w-full flex items-center justify-center cursor-pointer group my-1 relative z-10" onClick={() => handleAddEvent(index)}>
                    <div className="w-full h-px bg-slate-800 group-hover:bg-blue-500/50 transition-colors relative"></div>
                    <div className="absolute bg-slate-900 border border-blue-500/50 text-blue-400 text-[10px] px-3 py-1 rounded-full opacity-0 group-hover:opacity-100 transition-all transform scale-90 group-hover:scale-100 flex items-center gap-1 shadow-lg shadow-blue-900/20">
                        <Plus size={12} /> Insert
                    </div>
                </div>
            );

            // Get Current Dragged Card Data for Ghost Element
            const draggedEvent = events.find(e => e.id === dragState.draggedId);

            return (
                <div 
                    className="flex flex-col h-full bg-slate-950 text-slate-50 font-sans"
                    // Add listeners to reset timer if user scrolls *before* long press activates
                    onTouchMove={handleTouchEndCleanup}
                    onScroll={handleTouchEndCleanup}
                >
                    <header className="shrink-0 bg-slate-950/80 backdrop-blur border-b border-slate-800 p-4 pb-0 z-20 transition-all sticky top-0">
                        <div className="flex justify-between items-center mb-3">
                            <div>
                                <div className="text-[10px] tracking-widest text-slate-400 font-bold uppercase">å››å€‹æ°´æ‰‹è·¨å¹´åœ˜ðŸŒŠ</div>
                                <h1 className="text-lg font-bold">Thailand <span style={{color:PRIMARY_COLOR}}>Phuket Trip</span></h1>
                            </div>
                            <div className="text-right flex flex-col items-end">
                                <div className="bg-blue-900/30 border border-blue-500/30 text-blue-300 text-[10px] px-2 py-1 rounded-full mb-1 font-bold">ðŸ˜ {countdownText}</div>
                                <div className={`text-[10px] text-emerald-500 flex items-center gap-1 transition-opacity duration-500 ${isSaved ? "opacity-100" : "opacity-0"}`}><Cloud size={12} /> Saved</div>
                            </div>
                        </div>

                        {/* View Toggle */}
                        <div className="flex gap-2 mb-3">
                            <button onClick={() => setView('itinerary')} className={`flex-1 flex items-center justify-center gap-2 py-2 rounded-lg text-xs font-bold transition-all ${view === 'itinerary' ? 'bg-slate-800 text-white border border-slate-700' : 'text-slate-500 hover:text-slate-300'}`}>
                                <MapPin size={14} /> Itinerary
                            </button>
                            <button onClick={() => setView('docs')} className={`flex-1 flex items-center justify-center gap-2 py-2 rounded-lg text-xs font-bold transition-all ${view === 'docs' ? 'bg-emerald-900/40 text-emerald-300 border border-emerald-500/30' : 'text-slate-500 hover:text-slate-300'}`}>
                                <FileText size={14} /> Travel Docs
                            </button>
                        </div>

                        {view === 'itinerary' && (
                            <>
                                <div className="flex gap-2 overflow-x-auto pb-3 hide-scrollbar mb-1">
                                    {DATE_TABS.map(d => (
                                        <button key={d.iso} onClick={() => setSelectedDate(d.iso)} className={`shrink-0 px-4 py-2 rounded-full text-xs font-bold border transition-all ${selectedDate === d.iso ? "text-slate-950 border-transparent scale-105" : "border-slate-800 text-slate-400"}`} style={{background: selectedDate === d.iso ? `linear-gradient(135deg, ${PRIMARY_COLOR}, ${PRIMARY_COLOR}dd)` : 'rgba(30,41,59,0.5)'}}>
                                            {d.label}
                                        </button>
                                    ))}
                                </div>

                                <div className="relative mb-2">
                                    <div className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500"><Search size={14}/></div>
                                    <input
                                        type="text"
                                        placeholder="Search title, location, notes..."
                                        className="w-full bg-slate-900 border border-slate-700 rounded-lg py-2 pl-9 pr-8 text-xs text-slate-200 placeholder:text-slate-600 focus:outline-none focus:border-blue-500 transition-colors"
                                        value={searchQuery}
                                        onChange={(e) => setSearchQuery(e.target.value)}
                                    />
                                    {searchQuery && (
                                        <button onClick={() => setSearchQuery("")} className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-500 hover:text-slate-300">
                                            <X size={14}/>
                                        </button>
                                    )}
                                </div>
                            </>
                        )}
                    </header>

                    <main className="flex-1 overflow-y-auto p-4 pb-20 relative">
                        {view === 'docs' ? <DocsView /> : (
                            <div ref={listRef} className="bg-slate-900/50 border border-slate-800 rounded-2xl p-4 space-y-0 backdrop-blur-sm min-h-[300px]">
                                {eventsForSelectedDate.length === 0 && <div className="text-center py-10"><div className="text-slate-500 mb-2">{searchQuery ? "No matches found." : "No events today. ðŸ¥¥"}</div>{!searchQuery && <button onClick={() => handleAddEvent(-1)} className="text-xs bg-slate-800 hover:bg-slate-700 px-3 py-1.5 rounded-lg text-slate-300 transition-colors">+ Add First Event</button>}</div>}

                                {!searchQuery && eventsForSelectedDate.length > 0 && <AddZone index={0} />}

                                {eventsForSelectedDate.map((ev, i) => {
                                    const eventDateTime = new Date(`${ev.date}T${ev.time}`);
                                    const isPast = eventDateTime < now;
                                    const isCurrent = eventDateTime.getTime() - now.getTime() < 3600000 && eventDateTime.getTime() > now.getTime();
                                    
                                    const isExpanded = expandedEventId === ev.id;
                                    const isChecked = ev.isCompleted;
                                    const isEditing = editingId === ev.id;
                                    const isBeingDragged = dragState.isDragging && dragState.draggedId === ev.id;

                                    return (
                                        <React.Fragment key={ev.id}>
                                            {/* Drop Zone Hint - Before Item */}
                                            {dragState.isDragging && dragState.dropIndex === i && (
                                                <div className="drop-zone-hint">DROP HERE</div>
                                            )}

                                            <div
                                                data-event-card="true" // Marker for logic
                                                className={`flex gap-0 group relative transition-opacity duration-200 no-select rounded-xl overflow-hidden ${isBeingDragged ? "opacity-20 drag-placeholder" : ""}`}
                                                onTouchStart={(e) => handleTouchStart(e, ev.id)}
                                                onMouseDown={(e) => handleTouchStart(e, ev.id)} // For testing on desktop
                                                onTouchEnd={handleTouchEndCleanup}
                                                onMouseUp={handleTouchEndCleanup}
                                            >
                                                <div className={`w-12 bg-slate-900 border-r border-slate-800 flex items-center justify-center shrink-0 rounded-l-xl touch-none ${searchQuery ? "opacity-30 cursor-not-allowed" : "cursor-grab active:cursor-grabbing group-hover:bg-slate-800 transition-colors"}`}>
                                                    <GripVertical size={20} className="text-slate-500 group-hover:text-slate-300 transition-colors" />
                                                </div>

                                                <div className={`flex-1 border-y border-r border-slate-700 bg-slate-900/80 rounded-r-xl overflow-hidden transition-all relative flex flex-col 
                                                    ${isChecked || isPast ? "opacity-50 grayscale" : ""} 
                                                    ${isCurrent ? `ring-1 ring-[${PRIMARY_COLOR}] shadow-lg z-10 !opacity-100 !grayscale-0` : ""}
                                                    ${isBeingDragged ? "drag-selected" : ""} 
                                                `} onClick={() => !isEditing && setExpandedEventId(isExpanded ? null : ev.id)}>

                                                    <div className="flex flex-row relative">
                                                        <div className={`w-16 shrink-0 relative bg-slate-800 group/thumb ${isEditing ? 'hidden' : 'block'}`}>
                                                            <img
                                                                src={ev.imageUrl || DEFAULT_IMAGE}
                                                                onError={(e) => { e.target.onerror = null; e.target.src = DEFAULT_IMAGE; }}
                                                                className="absolute inset-0 w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity"
                                                                alt=""
                                                            />
                                                            <div className="absolute inset-0 bg-gradient-to-r from-black/20 to-transparent"></div>
                                                            <label
                                                                className="absolute inset-0 flex items-center justify-center bg-black/40 opacity-0 group-hover/thumb:opacity-100 transition-opacity cursor-pointer"
                                                                onClick={(e) => e.stopPropagation()}
                                                                title="Change Cover Image"
                                                            >
                                                                <Camera size={20} className="text-white drop-shadow-md" />
                                                                <input
                                                                    type="file"
                                                                    accept="image/*"
                                                                    className="hidden"
                                                                    onChange={(e) => handleCoverUpload(ev.id, e)}
                                                                />
                                                            </label>
                                                        </div>

                                                        <div className="flex-1 p-3 pr-14 flex flex-col justify-center min-w-0">
                                                            <div className="flex justify-between items-start gap-3">
                                                                <div className="min-w-0 flex-1">
                                                                    <div className="flex items-center gap-2 mb-1">
                                                                        {isEditing ? <input type="time" className="text-xs bg-slate-800 text-white border border-blue-500/50 rounded px-1 py-0 outline-none" value={ev.time} onClick={(e) => e.stopPropagation()} onChange={(e) => handleUpdateField(ev.id, 'time', e.target.value)} /> : <span className={`font-mono text-xs cursor-pointer hover:text-blue-400 hover:underline decoration-dashed transition-colors ${isCurrent ? `text-[${PRIMARY_COLOR}] font-bold` : "text-slate-400"}`} onClick={(e) => { e.stopPropagation(); setEditingId(ev.id); }} title="Click to Edit">{ev.time}</span>}
                                                                        {isEditing ? (
                                                                            <select className="text-[10px] bg-slate-800 border border-blue-500/50 rounded px-1 py-0 outline-none text-slate-300 ml-2" value={ev.type} onClick={(e) => e.stopPropagation()} onChange={(e) => handleUpdateField(ev.id, 'type', e.target.value)}>
                                                                                <option value="transport">äº¤é€š</option>
                                                                                <option value="activity">è¡Œç¨‹</option>
                                                                                <option value="food">ç¾Žé£Ÿ</option>
                                                                                <option value="stay">ä½å®¿</option>
                                                                                <option value="party">æ´¾å°</option>
                                                                                <option value="warning">æ³¨æ„</option>
                                                                            </select>
                                                                        ) : (
                                                                            <span className="text-[10px] px-1.5 rounded border border-slate-700 text-slate-400 ml-2">{typeLabels[ev.type] || ev.type}</span>
                                                                        )}
                                                                    </div>

                                                                    {isEditing ? (
                                                                        <div className="flex items-center gap-2 mt-1" onClick={e => e.stopPropagation()}>
                                                                            <input type="text" className="bg-slate-800 border border-blue-500/50 rounded px-2 py-1 text-sm font-bold text-white w-full outline-none focus:ring-1 focus:ring-blue-500" value={ev.title} placeholder="Event Title..." autoFocus onChange={(e) => handleUpdateField(ev.id, 'title', e.target.value)} onKeyDown={(e) => e.key === 'Enter' && setEditingId(null)} />
                                                                            <button onClick={() => setEditingId(null)} className="bg-emerald-600/20 text-emerald-500 border border-emerald-600/50 p-1 rounded hover:bg-emerald-600 hover:text-white transition-colors"><Check size={16} /></button>
                                                                        </div>
                                                                    ) : (
                                                                        <h3 className="font-semibold flex items-start gap-2 text-slate-100 mt-1">
                                                                            <span className="opacity-90 shrink-0 mt-0.5">{getCategoryIcon(ev.type)}</span>
                                                                            <span className="block break-words leading-tight" onClick={(e) => { e.stopPropagation(); setEditingId(ev.id); }}>
                                                                                <HighlightText text={ev.title} highlight={searchQuery} />
                                                                            </span>
                                                                            <button onClick={(e) => { e.stopPropagation(); setEditingId(ev.id); }} className="opacity-0 group-hover:opacity-50 hover:!opacity-100 text-slate-500 transition-opacity ml-1 shrink-0 mt-0.5"><Edit2 size={12} /></button>
                                                                        </h3>
                                                                    )}

                                                                    <div className="flex items-center gap-2 mt-1.5 min-w-0">
                                                                        {isEditing ? (
                                                                            <div className="flex items-center gap-1 w-full" onClick={e => e.stopPropagation()}>
                                                                                <MapPin size={12} className="text-slate-500 shrink-0" />
                                                                                <input type="text" className="bg-slate-800 text-xs border border-blue-500/50 rounded px-1 py-0.5 text-slate-300 w-full outline-none focus:ring-1 focus:ring-blue-500" value={ev.location || ""} placeholder="Enter location for map..." onChange={(e) => handleUpdateField(ev.id, 'location', e.target.value)} />
                                                                            </div>
                                                                        ) : (
                                                                            ev.location && (
                                                                                <>
                                                                                    <div className="flex items-center gap-1 min-w-0 overflow-hidden">
                                                                                        <MapPin size={12} className="text-slate-400 shrink-0"/>
                                                                                        <span className="text-xs text-slate-400 truncate"><HighlightText text={ev.location} highlight={searchQuery} /></span>
                                                                                    </div>
                                                                                    <button onClick={(e) => { e.stopPropagation(); handleOpenMap(ev.location, ev.title, ev.mapLink); }} className="text-blue-400 hover:text-blue-300 p-1 shrink-0 active:scale-95 transition-transform ml-1" title="Navigate with Google Maps"><MapIcon size={14} /></button>
                                                                                </>
                                                                            )
                                                                        )}
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            {!isEditing && <p className="text-xs text-slate-300 mt-2 line-clamp-2"><HighlightText text={ev.shortDescription} highlight={searchQuery} /></p>}
                                                            <div className="absolute top-3 right-3 flex flex-col gap-2" onClick={e => e.stopPropagation()}>
                                                                <button onClick={() => handleToggleChecked(ev.id)} className={`w-8 h-8 rounded-full border flex items-center justify-center shrink-0 transition-all ${isChecked ? "bg-emerald-500/20 border-emerald-500 text-emerald-500" : "border-slate-700 text-slate-600 hover:bg-slate-800"}`}>{isChecked && "âœ“"}</button>
                                                                <button onClick={() => handleDeleteEvent(ev.id)} className="w-8 h-8 rounded-full border border-slate-700 text-slate-500 flex items-center justify-center hover:bg-red-500/20 hover:border-red-500 hover:text-red-500 transition-all"><Trash2 size={14} /></button>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    {isExpanded && !isEditing && (
                                                        <div className="bg-slate-950/50 border-t border-slate-800 p-3 space-y-3 animate-in slide-in-from-top-2">
                                                            <textarea onClick={e=>e.stopPropagation()} value={ev.userNotes || ""} onChange={e=> handleNoteChange(ev.id, e.target.value)} className="w-full bg-slate-900 border border-slate-700 rounded-lg text-xs p-2 text-slate-200 focus:outline-none focus:border-[color:#3D9FBD]" placeholder="Notes..." rows={2}></textarea>

                                                            {searchQuery && ev.userNotes && ev.userNotes.toLowerCase().includes(searchQuery.toLowerCase()) && (
                                                                <div className="text-xs p-2 bg-yellow-900/30 border border-yellow-700/50 rounded text-slate-300 mb-2">
                                                                    Match in notes: "...<HighlightText text={ev.userNotes} highlight={searchQuery}/>..."
                                                                </div>
                                                            )}

                                                            <div className="relative group/cover">
                                                                <img
                                                                    src={ev.imageUrl || DEFAULT_IMAGE}
                                                                    onError={(e) => { e.target.onerror = null; e.target.src = DEFAULT_IMAGE; }}
                                                                    className="w-full h-32 object-cover rounded-lg border border-slate-700"
                                                                    alt="Event visual"
                                                                />
                                                                <label
                                                                    className="absolute inset-0 flex items-center justify-center bg-black/40 opacity-0 group-hover/cover:opacity-100 transition-opacity cursor-pointer rounded-lg"
                                                                    onClick={(e) => e.stopPropagation()}
                                                                >
                                                                    <span className="flex items-center gap-2 text-white font-bold text-sm bg-black/50 px-3 py-1.5 rounded-full backdrop-blur-sm"><Camera size={14}/> Change Cover</span>
                                                                    <input type="file" accept="image/*" className="hidden" onChange={(e) => handleCoverUpload(ev.id, e)}/>
                                                                </label>
                                                            </div>

                                                            {ev.images?.map((src,k)=><img key={k} src={src} className="w-full h-24 object-cover rounded-lg border border-slate-700" alt={`Upload ${k}`} />)}

                                                            <label onClick={e=>e.stopPropagation()} className="block w-full py-2 border border-dashed border-slate-600 rounded-lg text-center text-xs text-slate-400 cursor-pointer hover:bg-slate-800">
                                                                <span className="flex items-center justify-center gap-2"><ImageIcon size={14}/> {processingImage ? "Compressing..." : "Add Photo"}</span>
                                                                <input type="file" accept="image/*" className="hidden" onChange={(e) => handleImageUpload(ev.id, e)}/>
                                                            </label>

                                                            <div className="flex justify-center"><ChevronUp size={16} className="text-slate-600 cursor-pointer" onClick={() => setExpandedEventId(null)}/></div>
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                            {!searchQuery && <AddZone index={i + 1} />}
                                        </React.Fragment>
                                    );
                                })}

                                {/* Drop Zone Hint - After Last Item */}
                                {dragState.isDragging && dragState.dropIndex === eventsForSelectedDate.length && (
                                    <div className="drop-zone-hint">DROP HERE</div>
                                )}
                            </div>
                        )}
                        
                        {/* Floating Clone for Visual Feedback */}
                        {dragState.isDragging && draggedEvent && (
                            <div className="floating-card" 
                                style={{ top: dragState.currentY - 40, left: dragState.currentX - 40 }}>
                                <div className="w-12 h-12 rounded bg-slate-800 shrink-0 overflow-hidden">
                                    <img src={draggedEvent.imageUrl || DEFAULT_IMAGE} className="w-full h-full object-cover" />
                                </div>
                                <div>
                                    <div className="font-bold text-sm text-white drop-shadow-md">{draggedEvent.title}</div>
                                    <div className="text-xs text-emerald-300 drop-shadow-md">{draggedEvent.time}</div>
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<PhuketTripApp />);
    </script>
</body>
</html>