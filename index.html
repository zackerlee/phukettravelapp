<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Thailand Phuket Trip 2025</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Drag and Drop Polyfill for Mobile -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mobile-drag-drop@2.3.0-rc.2/default.css">
    <script src="https://cdn.jsdelivr.net/npm/mobile-drag-drop@2.3.0-rc.2/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mobile-drag-drop@2.3.0-rc.2/scroll-behaviour.min.js"></script>

    <style>
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes popBounce { 0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(52, 211, 153, 0.7); } 50% { transform: scale(1.02); box-shadow: 0 0 20px 0 rgba(52, 211, 153, 0.4); border-color: #34d399; } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(52, 211, 153, 0); } }
        .pop-success { animation: popBounce 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); z-index: 20; }
        .no-select { -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; }

        /* Dragging Styles */
        .is-dragging { opacity: 0.4; border: 2px dashed #3D9FBD; background: #0f172a; filter: grayscale(100%); }
        .drag-over-target { border-top: 60px solid rgba(61, 159, 189, 0.15) !important; transition: border-top 0.2s cubic-bezier(0.2, 0.8, 0.2, 1); position: relative; }
        .drag-over-target::before { content: "Drop Here"; position: absolute; top: -45px; left: 0; right: 0; text-align: center; color: #3D9FBD; font-size: 10px; font-weight: bold; letter-spacing: 1px; text-transform: uppercase; pointer-events: none; }

        /* Mobile Drag Polyfill Override */
        .dnd-poly-drag-image { opacity: 0.95 !important; background: #1e293b !important; border-radius: 12px; box-shadow: 0 20px 40px -10px rgba(0,0,0,0.6); padding: 0; width: 300px !important; border: 2px solid #3D9FBD; transform: scale(1.05) rotate(2deg); }
        
        /* Glassmorphism utilities */
        .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
    </style>
</head>
<body class="bg-slate-950 text-slate-50 h-screen overflow-hidden">
    <div id="root" class="h-full"></div>

    <script>
        // Polyfill configuration
        var MobileDragDrop = MobileDragDrop || {};
        MobileDragDrop.polyfill({
            dragImageTranslateOverride: MobileDragDrop.scrollBehaviourDragImageTranslateOverride,
            holdToDrag: 150,
            iterationIntervalMs: 50
        });
        document.addEventListener("touchmove", function(e) {}, {passive: false});
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- Icons ---
        const IconBase = ({ size = 16, className = "", children, ...props }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>
        );

        const Plane = (props) => <IconBase {...props}><path d="M2 12h20"/><path d="M13 2l9 10-9 10"/><path d="M2 12l5-5m0 10l-5-5"/></IconBase>;
        const Hotel = (props) => <IconBase {...props}><path d="M2 4v16"/><path d="M2 8h18a2 2 0 0 1 2 2v10"/><path d="M2 17h20"/><path d="M6 8v9"/></IconBase>;
        const Utensils = (props) => <IconBase {...props}><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"/></IconBase>;
        const MapPin = (props) => <IconBase {...props}><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></IconBase>;
        const Camera = (props) => <IconBase {...props}><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></IconBase>;
        const Sun = (props) => <IconBase {...props}><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41-1.41"/><path d="m19.07 4.93-1.41 1.41"/></IconBase>;
        const AlertTriangle = (props) => <IconBase {...props}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></IconBase>;
        const Plus = (props) => <IconBase {...props} strokeWidth="3"><path d="M5 12h14"/><path d="M12 5v14"/></IconBase>;
        const Trash2 = (props) => <IconBase {...props}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconBase>;
        const GripVertical = (props) => <IconBase {...props}><circle cx="9" cy="12" r="1"/><circle cx="9" cy="5" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="19" r="1"/></IconBase>;
        const Check = (props) => <IconBase {...props} strokeWidth="3"><polyline points="20 6 9 17 4 12"/></IconBase>;
        const Edit2 = (props) => <IconBase {...props}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></IconBase>;
        const MapIcon = (props) => <IconBase {...props}><polygon points="3 11 22 2 13 21 11 13 3 11"/><line x1="11" x2="13" y1="13" y2="21"/></IconBase>;
        const Cloud = (props) => <IconBase {...props}><path d="M17.5 19c0-1.7-1.3-3-3-3h-1.1c-.2-3.2-2.7-5.8-5.9-6-3.3.2-6 2.8-6.2 6.1H.5c-1.7 0-3 1.3-3 3s1.3 3 3 3h17c1.7 0 3-1.3 3-3z"/></IconBase>;
        const Search = (props) => <IconBase {...props}><circle cx="11" cy="11" r="8"/><line x1="21" x2="16.65" y1="21" y2="16.65"/></IconBase>;
        const X = (props) => <IconBase {...props}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></IconBase>;
        const ImageIcon = (props) => <IconBase {...props}><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></IconBase>;
        const ChevronUp = (props) => <IconBase {...props}><path d="m18 15-6-6-6 6"/></IconBase>;
        const FileText = (props) => <IconBase {...props}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></IconBase>;
        const ExternalLink = (props) => <IconBase {...props}><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></IconBase>;
        const Briefcase = (props) => <IconBase {...props}><rect width="20" height="14" x="2" y="7" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></IconBase>;
        const ArrowRightLeft = (props) => <IconBase {...props}><path d="m16 3 4 4-4 4"/><path d="M20 7H4"/><path d="m8 21-4-4 4-4"/><path d="M4 17h16"/></IconBase>;
        const Coins = (props) => <IconBase {...props}><circle cx="8" cy="8" r="6"/><path d="M18.09 10.37A6 6 0 1 1 10.34 18"/><path d="M7 6h1v4"/><path d="m16.71 13.88.7 .71-2.82 2.82"/></IconBase>;

        // --- Config ---
        const LOCAL_STORAGE_KEY = "phuket-trip-2025-data";
        const CHECKLIST_STORAGE_KEY = "phuket-trip-checklist-v2";
        const PRIMARY_COLOR = "#3D9FBD";
        const TRIP_START_DATE = "2025-12-30";
        const DEFAULT_IMAGE = "https://images.unsplash.com/photo-1476514525535-07fb3b4ae5f1?auto=format&fit=crop&w=400&q=80";

        const DATE_TABS = [
            { label: "12/30 (Tue)", iso: "2025-12-30" },
            { label: "12/31 (Wed)", iso: "2025-12-31" },
            { label: "01/01 (Thu)", iso: "2026-01-01" },
            { label: "01/02 (Fri)", iso: "2026-01-02" },
            { label: "01/03 (Sat)", iso: "2026-01-03" },
        ];

        // Initial Data
        const INITIAL_EVENTS = [
            // Day 1: 12/30
            { id: "e1", date: "2025-12-30", time: "17:20", title: "ÊäµÈÅîÊôÆÂêâÂ≥∂Ê©üÂ†¥ (HKT)", type: "transport", location: "Phuket International Airport", shortDescription: "ÈÄöÈóúËàáÈ†òË°åÊùéÁ¥ÑÈúÄ 1 Â∞èÊôÇÔºåË∑®Âπ¥‰∫∫ÊΩÆÁúæÂ§ö„ÄÇ", imageUrl: "https://images.unsplash.com/photo-1436491865332-7a61a109cc05?auto=format&fit=crop&w=400&q=80" },
            { id: "e2", date: "2025-12-30", time: "18:30", title: "ÂèñËªäÂá∫Áôº (Drive Thailand)", type: "transport", location: "Airport Car Rental", shortDescription: "ÂøÉÁêÜÊ∫ñÂÇôÔºöÈÄ≤Â∑¥Êù±ËªäÁ®ãÁ¥Ñ 2 Â∞èÊôÇ (Âö¥ÈáçÂ°ûËªä)„ÄÇ", imageUrl: "https://images.unsplash.com/photo-1449965408869-eaa3f722e40d?auto=format&fit=crop&w=400&q=80" },
            { id: "e3", date: "2025-12-30", time: "20:00", title: "Check-in: Fusion Suites", type: "stay", location: "Fusion Suites Phuket Patong", shortDescription: "Â∑¥Êù±ÂçÄÈ£ØÂ∫óÔºå‰ΩçÁΩÆÊñπ‰æøÔºåÊúâÊ≥≥Ê±†„ÄÇ", imageUrl: "https://images.unsplash.com/photo-1566073771259-6a8506099945?auto=format&fit=crop&w=400&q=80" },
            { id: "e4", date: "2025-12-30", time: "20:30", title: "ÊôöÈ§êÔºöÊ≥∞ÂºèÊñôÁêÜ", type: "food", location: "No.6 Restaurant / Kaab Gluay", shortDescription: "Êé®Ëñ¶ No.6 on the Hill (È¢®ÊôØÂ•Ω) Êàñ Kaab Gluay (Âú®Âú∞)ÔºåÈÅøÈñãÁ∏ΩÂ∫óÊéíÈöä„ÄÇ", imageUrl: "https://images.unsplash.com/photo-1559314809-0d155014e29e?auto=format&fit=crop&w=400&q=80" },
            { id: "e5", date: "2025-12-30", time: "22:00", title: "Bangla Road Êï£Ê≠•", type: "activity", location: "Bangla Road", shortDescription: "ÊÑüÂèóÈÖíÂêßË°óÊ∞£Ê∞õÔºå7-11 Êé°Ë≤∑Ë£úÁµ¶„ÄÇ", imageUrl: "https://images.unsplash.com/photo-1566737236500-c8ac43014a67?auto=format&fit=crop&w=400&q=80" },
            // Day 2: 12/31
            { id: "e6", date: "2025-12-31", time: "08:00", title: "Â§ßË±°‰øùË≠∑ÂçÄ (Morning Visit)", type: "activity", location: "Elephant Jungle Sanctuary", shortDescription: "È´îÈ©óÈ§µÈ£üËàáÊ≥•ÊºøÊµ¥ÔºåÈÅøÈñã‰∏ãÂçàÈÖ∑ÁÜ±„ÄÇ", imageUrl: "https://images.unsplash.com/photo-1585970480901-90d63348d801?auto=format&fit=crop&w=400&q=80" },
            { id: "e7", date: "2025-12-31", time: "14:00", title: "Á∂≤ÁæéÂíñÂï°Âª≥", type: "food", location: "Three Monkeys Restaurant", shortDescription: "Three Monkeys (Âè¢ÊûóÈ¢®) Êàñ The Feelsion (Âæ©Âè§È¢®)„ÄÇ", imageUrl: "https://images.unsplash.com/photo-1554118811-1e0d58224f24?auto=format&fit=crop&w=400&q=80" },
            { id: "e8", date: "2025-12-31", time: "16:30", title: "‚ö†Ô∏è ÈóúÈçµÔºöÂõûÈ£ØÂ∫óÂÅúËªä", type: "warning", location: "Fusion Suites Parking", shortDescription: "18:00 ÂæåÂ∞ÅË∑ØÔºÅÂãôÂøÖÂú® 17:00 ÂâçÊääËªäÂÅúÂ•ΩÔºå‰πãÂæåÂÖ®Ê≠•Ë°å„ÄÇ", imageUrl: "https://images.unsplash.com/photo-1625902364860-705307372d3f?auto=format&fit=crop&w=400&q=80" },
            { id: "e9", date: "2025-12-31", time: "23:50", title: "Ë∑®Âπ¥ÁÖôÁÅ´ÁßÄ üéÜ", type: "party", location: "Patong Beach", shortDescription: "Â∏∂ËëóÂï§ÈÖíÂú®Ê≤ôÁÅòÂÄíÊï∏ÔºåÊ¨£Ë≥ûÁÖôÁÅ´„ÄÇ", imageUrl: "https://images.unsplash.com/photo-1467810563316-b5476525c0f9?auto=format&fit=crop&w=400&q=80" },
            // Day 3: 01/01
            { id: "e10", date: "2026-01-01", time: "10:00", title: "ÂåÖËàπÂéª Freedom Beach", type: "activity", location: "Freedom Beach", shortDescription: "‰∏çË¶ÅËµ∞Â±±Ë∑ØÔºÅÂæû Patong ÂåÖÈï∑Â∞æËàπ‰æÜÂõûÔºåÂ∏•Ê∞£ÂèàËºïÈ¨Ü„ÄÇ", imageUrl: "https://images.unsplash.com/photo-1589394815804-964ed0be2eb5?auto=format&fit=crop&w=400&q=80" },
            { id: "e11", date: "2026-01-01", time: "15:30", title: "Check-in: Seabed Grand", type: "stay", location: "Seabed Grand Hotel Phuket", shortDescription: "ÁßªÂãïÂà∞ÊôÆÂêâÈéÆÂë®ÈÇäÔºåÊ∫ñÂÇôÈÄõÂ§úÂ∏ÇËàáË∑≥Â≥∂„ÄÇ", imageUrl: "https://images.unsplash.com/photo-1618773928121-c32242e63f39?auto=format&fit=crop&w=400&q=80" },
            { id: "e12", date: "2026-01-01", time: "16:30", title: "ÊôÆÂêâËàäÂüéÂçÄ & Ê≥ïÂºèÂêêÂè∏", type: "activity", location: "Old Town Phuket", shortDescription: "Phuketique ÊäΩËôüÁ¢ºÁâåÔºåÈÄõ Old Town Âª∫ÁØâ„ÄÇ", imageUrl: "https://images.unsplash.com/photo-1605707733671-59727409249e?auto=format&fit=crop&w=400&q=80" },
            { id: "e13", date: "2026-01-01", time: "19:00", title: "ÊôöÈ§êÔºöÁ±≥ÂÖ∂ÊûóÊé®Ëñ¶", type: "food", location: "Tu Kab Khao", shortDescription: "Tu Kab Khao Êàñ One ChunÔºåÈÅìÂú∞Ê≥∞ÂçóËèú„ÄÇ", imageUrl: "https://images.unsplash.com/photo-1563897539633-7374c278c224?auto=format&fit=crop&w=400&q=80" },
            // Day 4: 01/02
            { id: "e14", date: "2026-01-02", time: "09:00", title: "ÁöÆÁöÆÂ≥∂‰∏ÄÊó•ÈÅä (Phi Phi)", type: "activity", location: "Phi Phi Islands", shortDescription: "Maya Bay, Pileh Lagoon Ë∑≥Ê∞¥„ÄÇË®òÂæóÂêÉÊöàËàπËó•„ÄÇ", imageUrl: "https://images.unsplash.com/photo-1537956965359-35780d64d509?auto=format&fit=crop&w=400&q=80" },
            { id: "e15", date: "2026-01-02", time: "19:30", title: "Chillva Market (ÈùíËõôÂ§úÂ∏Ç)", type: "food", location: "Chillva Market", shortDescription: "ÈÄ±‰∫îÊúÄÁÜ±È¨ßÔºåÂêÉÊµ∑ÈÆÆÊ°∂„ÄÅË≤∑Ë°£Êúç„ÄÇ", imageUrl: "https://images.unsplash.com/photo-1534438097545-a2c22c57f271?auto=format&fit=crop&w=400&q=80" },
            // Day 5: 01/03
            { id: "e16", date: "2026-01-03", time: "13:30", title: "Ma Doo Bua Ëç∑ËëâÂíñÂï°", type: "food", location: "Ma Doo Bua", shortDescription: "Á∂≤ÁæéÂøÖÊãçÔºå‰ΩçÊñºÂåóÈÉ®ÂæÄÊ©üÂ†¥È†ÜË∑Ø„ÄÇ", imageUrl: "https://images.unsplash.com/photo-1528163939626-d5d1c5d00fc6?auto=format&fit=crop&w=400&q=80" },
            { id: "e17", date: "2026-01-03", time: "16:00", title: "‚ö†Ô∏è Âá∫ÁôºÂéªÊ©üÂ†¥", type: "warning", location: "En route to Airport", shortDescription: "ÁµïÂ∞çË¶ÅÊèêÊó©ÔºÅÈ†êÁïôÈÇÑËªäËàáÂ°ûËªäÊôÇÈñì„ÄÇ", imageUrl: "https://images.unsplash.com/photo-1570710891163-6d3b5c47248b?auto=format&fit=crop&w=400&q=80" },
            { id: "e18", date: "2026-01-03", time: "17:30", title: "ÊäµÈÅîÊ©üÂ†¥ÈÇÑËªä", type: "transport", location: "Phuket Airport", shortDescription: "Ëæ¶ÁêÜÈÇÑËªä„ÄÅÈÄÄÁ®Ö„ÄÅCheck-in„ÄÇ", imageUrl: "https://images.unsplash.com/photo-1530521954074-e64f6810b32d?auto=format&fit=crop&w=400&q=80" },
        ];

        // --- Highlight Text ---
        const HighlightText = ({ text, highlight, className = "" }) => {
            if (!highlight || !highlight.trim() || !text) return <span className={className}>{text}</span>;
            const parts = text.toString().split(new RegExp(`(${highlight})`, 'gi'));
            return (
                <span className={className}>
                    {parts.map((part, i) =>
                        part.toLowerCase() === highlight.toLowerCase()
                            ? <span key={i} className="bg-yellow-500/30 text-yellow-200 rounded px-0.5">{part}</span>
                            : part
            )}
                </span>
            );
        };

        // --- Docs View Component ---
        const DocsView = () => {
            const [checklist, setChecklist] = useState(() => {
                const saved = localStorage.getItem(CHECKLIST_STORAGE_KEY);
                return saved ? JSON.parse(saved) : [
                    { id: "c1", label: "Passport (Validity > 6 months)", checked: false },
                    { id: "c2", label: "TDAC Digital Arrival Card (QR Code)", checked: false },
                    { id: "c3", label: "Return Flight Ticket", checked: false },
                    { id: "c4", label: "Hotel Vouchers / Booking", checked: false },
                    { id: "c5", label: "Travel Insurance (Recommended)", checked: false },
                    { id: "c6", label: "Exchange Thai Baht (Cash)", checked: false },
                    { id: "c7", label: "SIM Card / Roaming", checked: false },
                ];
            });

            const [newItemText, setNewItemText] = useState("");
            
            // Currency Converter State
            const [amount, setAmount] = useState(100);
            const [direction, setDirection] = useState("THB_TO_TWD"); // "THB_TO_TWD" or "TWD_TO_THB"
            const [exchangeRate, setExchangeRate] = useState(0.92); // Fallback: 1 THB = 0.92 TWD
            const [isLoadingRate, setIsLoadingRate] = useState(false);
            const [lastUpdated, setLastUpdated] = useState(null);

            useEffect(() => {
                localStorage.setItem(CHECKLIST_STORAGE_KEY, JSON.stringify(checklist));
            }, [checklist]);

            // Fetch Real-time Rates
            useEffect(() => {
                setIsLoadingRate(true);
                // Using a free API that generally supports CORS for demos. 
                // If it fails, we keep the fallback default.
                fetch('https://api.exchangerate-api.com/v4/latest/THB')
                    .then(res => res.json())
                    .then(data => {
                        if(data.rates && data.rates.TWD) {
                            setExchangeRate(data.rates.TWD);
                            setLastUpdated(new Date().toLocaleTimeString());
                        }
                        setIsLoadingRate(false);
                    })
                    .catch(err => {
                        console.warn("Rate fetch failed, using fallback", err);
                        setIsLoadingRate(false);
                    });
            }, []);

            const toggleCheck = (id) => {
                setChecklist(prev => prev.map(item => item.id === id ? { ...item, checked: !item.checked } : item));
            };

            const handleAddChecklist = (e) => {
                e.preventDefault();
                if(!newItemText.trim()) return;
                setChecklist(prev => [...prev, { id: `c-${Date.now()}`, label: newItemText, checked: false }]);
                setNewItemText("");
            };

            const handleDeleteChecklist = (id) => {
                if(confirm("Remove this item?")) {
                    setChecklist(prev => prev.filter(i => i.id !== id));
                }
            };

            // Calculation
            const convertedResult = useMemo(() => {
                const val = parseFloat(amount) || 0;
                if (direction === "THB_TO_TWD") {
                    return (val * exchangeRate).toFixed(1);
                } else {
                    return (val / exchangeRate).toFixed(1);
                }
            }, [amount, direction, exchangeRate]);

            return (
                <div className="space-y-4 animate-in fade-in slide-in-from-bottom-4 duration-500 pb-20">
                    
                    {/* Currency Converter */}
                    <div className="bg-gradient-to-br from-emerald-900/80 to-slate-900 border border-emerald-500/50 rounded-2xl p-5 shadow-lg relative overflow-hidden">
                        <div className="absolute -right-6 -top-6 opacity-10 text-emerald-300"><Coins size={120} /></div>
                        
                        <div className="flex justify-between items-start mb-4 relative z-10">
                            <h2 className="text-lg font-bold text-emerald-100 flex items-center gap-2">
                                <Coins size={20} className="text-emerald-400"/> Rate Converter
                            </h2>
                            <div className="text-[10px] text-emerald-400/70 text-right">
                                {isLoadingRate ? "Updating..." : (lastUpdated ? `Updated: ${lastUpdated}` : "Est. Rate")}
                                <div className="font-mono">1 THB ‚âà {exchangeRate.toFixed(3)} TWD</div>
                            </div>
                        </div>

                        <div className="flex flex-col gap-4 relative z-10">
                            <div className="flex items-center gap-3 bg-slate-900/50 p-1 rounded-xl border border-emerald-500/30">
                                <div className="flex-1 text-center py-2 px-3 rounded-lg font-bold text-sm transition-colors text-white bg-emerald-600 shadow-sm">
                                    {direction === "THB_TO_TWD" ? "üáπüá≠ THB" : "üáπüáº TWD"}
                                </div>
                                <button 
                                    onClick={() => setDirection(prev => prev === "THB_TO_TWD" ? "TWD_TO_THB" : "THB_TO_TWD")}
                                    className="p-2 rounded-full hover:bg-white/10 text-emerald-300 active:scale-90 transition-transform"
                                >
                                    <ArrowRightLeft size={18} />
                                </button>
                                <div className="flex-1 text-center py-2 px-3 rounded-lg font-bold text-sm transition-colors text-emerald-100/50">
                                    {direction === "THB_TO_TWD" ? "üáπüáº TWD" : "üáπüá≠ THB"}
                                </div>
                            </div>

                            <div className="flex items-end gap-3">
                                <div className="flex-1">
                                    <label className="text-xs text-emerald-400/70 ml-1 mb-1 block">Amount</label>
                                    <input 
                                        type="number" 
                                        value={amount} 
                                        onChange={(e) => setAmount(e.target.value)}
                                        className="w-full bg-slate-900/80 border border-emerald-500/30 rounded-xl px-4 py-3 text-xl font-mono text-white focus:outline-none focus:border-emerald-400"
                                    />
                                </div>
                                <div className="pb-3 text-emerald-500 font-bold text-xl">=</div>
                                <div className="flex-1">
                                    <label className="text-xs text-emerald-400/70 ml-1 mb-1 block">Result</label>
                                    <div className="w-full bg-emerald-900/30 border border-emerald-500/30 rounded-xl px-4 py-3 text-xl font-mono text-emerald-200 text-right overflow-hidden text-ellipsis">
                                        {convertedResult}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Important Alert Card (TDAC) */}
                    <div className="glass-panel rounded-2xl p-4 shadow-lg flex items-start gap-3">
                        <div className="bg-indigo-500/20 p-2 rounded-lg text-indigo-300 shrink-0 mt-1"><Briefcase size={20}/></div>
                        <div>
                            <h3 className="font-bold text-indigo-200 text-sm">Digital Arrival Card (TDAC)</h3>
                            <p className="text-xs text-slate-400 mt-1 mb-2">Mandatory for all visitors. Submit online within 3 days before arrival.</p>
                            <a href="https://tdac.immigration.go.th" target="_blank" className="text-xs bg-indigo-600 hover:bg-indigo-500 text-white px-3 py-1.5 rounded-md inline-flex items-center gap-1 transition-colors">
                                Open TDAC Website <ExternalLink size={10} />
                            </a>
                        </div>
                    </div>

                    {/* Editable Checklist */}
                    <div className="glass-panel rounded-2xl p-5 shadow-lg">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="font-bold text-slate-200 flex items-center gap-2"><Check size={18} className="text-emerald-400"/> Trip Checklist</h3>
                            <span className="text-xs bg-slate-800 px-2 py-1 rounded text-slate-400 font-mono">{checklist.filter(i=>i.checked).length}/{checklist.length}</span>
                        </div>
                        
                        <div className="space-y-2 mb-4">
                            {checklist.map(item => (
                                <div key={item.id} className="flex items-center gap-3 p-2 hover:bg-slate-800/50 rounded-lg group transition-colors">
                                    <div 
                                        onClick={() => toggleCheck(item.id)}
                                        className={`w-5 h-5 rounded border flex items-center justify-center shrink-0 cursor-pointer transition-all ${item.checked ? "bg-emerald-500 border-emerald-500" : "border-slate-600 hover:border-emerald-400"}`}
                                    >
                                        {item.checked && <Check size={12} className="text-white" />}
                                    </div>
                                    <span 
                                        onClick={() => toggleCheck(item.id)}
                                        className={`text-sm flex-1 cursor-pointer select-none ${item.checked ? "text-slate-500 line-through" : "text-slate-300"}`}
                                    >
                                        {item.label}
                                    </span>
                                    <button 
                                        onClick={() => handleDeleteChecklist(item.id)}
                                        className="text-slate-600 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity p-1"
                                    >
                                        <Trash2 size={14} />
                                    </button>
                                </div>
                            ))}
                        </div>

                        <form onSubmit={handleAddChecklist} className="flex gap-2 border-t border-slate-700/50 pt-4">
                            <input 
                                type="text" 
                                value={newItemText} 
                                onChange={(e) => setNewItemText(e.target.value)}
                                placeholder="Add new item..." 
                                className="flex-1 bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-xs text-white focus:outline-none focus:border-emerald-500 transition-colors"
                            />
                            <button type="submit" disabled={!newItemText.trim()} className="bg-emerald-600 hover:bg-emerald-500 disabled:opacity-50 disabled:cursor-not-allowed text-white rounded-lg px-3 py-2 transition-colors">
                                <Plus size={16} />
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        const PhuketTripApp = () => {
            const [view, setView] = useState('itinerary'); // 'itinerary' | 'docs'
            
            // Auto-detect date on load
            const [selectedDate, setSelectedDate] = useState(() => {
                const d = new Date();
                const todayIso = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
                const found = DATE_TABS.find(t => t.iso === todayIso);
                return found ? found.iso : DATE_TABS[0].iso;
            });

            const [expandedEventId, setExpandedEventId] = useState(null);
            const [events, setEvents] = useState([]);
            const [draggedEventId, setDraggedEventId] = useState(null);
            const [dragOverId, setDragOverId] = useState(null);
            const [droppedId, setDroppedId] = useState(null);
            const [editingId, setEditingId] = useState(null);
            const [processingImage, setProcessingImage] = useState(false);
            const [isSaved, setIsSaved] = useState(true);
            const [searchQuery, setSearchQuery] = useState("");

            // --- Countdown ---
            const daysToGo = useMemo(() => {
                const start = new Date(TRIP_START_DATE);
                const today = new Date();
                const diffTime = start - today;
                return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            }, []);

            const countdownText = daysToGo > 0
                ? `${daysToGo} Days to Go`
                : (daysToGo === 0 ? "Trip is Today!" : `Day ${Math.abs(daysToGo) + 1} of Trip`);

            // --- Persistence ---
            useEffect(() => {
                try {
                    const raw = localStorage.getItem(LOCAL_STORAGE_KEY);
                    setEvents(raw ? JSON.parse(raw) : INITIAL_EVENTS);
                } catch (e) { setEvents(INITIAL_EVENTS); }
            }, []);

            useEffect(() => {
                if (events.length > 0) {
                    try {
                        localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(events));
                        setIsSaved(true);
                        const timer = setTimeout(() => setIsSaved(false), 2000);
                        return () => clearTimeout(timer);
                    } catch (e) { console.error("Storage full", e); }
                }
            }, [events]);

            const now = new Date();

            // --- Logic ---
            const eventsForSelectedDate = useMemo(() => {
                let filtered = events.filter(e => e.date === selectedDate);
                if (searchQuery.trim()) {
                    const q = searchQuery.toLowerCase();
                    filtered = filtered.filter(e =>
                        (e.title && e.title.toLowerCase().includes(q)) ||
                        (e.location && e.location.toLowerCase().includes(q)) ||
                        (e.shortDescription && e.shortDescription.toLowerCase().includes(q)) ||
                        (e.userNotes && e.userNotes.toLowerCase().includes(q))
                    );
                }
                return filtered.sort((a, b) => a.time.localeCompare(b.time));
            }, [events, selectedDate, searchQuery]);

            const handleToggleChecked = (id) => setEvents(prev => prev.map(ev => ev.id === id ? { ...ev, isCompleted: !ev.isCompleted } : ev));
            const handleNoteChange = (id, text) => setEvents(prev => prev.map(ev => ev.id === id ? { ...ev, userNotes: text } : ev));
            const handleDeleteEvent = (id) => { if(confirm("Delete this event?")) setEvents(prev => prev.filter(ev => ev.id !== id)); };
            const handleUpdateField = (id, field, value) => { setEvents(prev => prev.map(ev => ev.id === id ? { ...ev, [field]: value } : ev)); };

            const handleOpenMap = (location, title) => {
                const query = encodeURIComponent(`${location} ${title || ''}`);
                window.open(`https://www.google.com/maps/search/?api=1&query=${query}`, '_blank');
            };

            const handleImageUpload = (id, e) => {
                const file = e.target.files[0];
                if (!file) return;
                setProcessingImage(true);
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const MAX_WIDTH = 800; const MAX_HEIGHT = 800;
                        let width = img.width; let height = img.height;
                        if (width > height) { if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; } }
                        else { if (height > MAX_HEIGHT) { width *= MAX_HEIGHT / height; height = MAX_HEIGHT; } }
                        canvas.width = width; canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        const compressedBase64 = canvas.toDataURL('image/jpeg', 0.7);
                        setEvents(prev => prev.map(ev => ev.id === id ? { ...ev, images: [...(ev.images || []), compressedBase64] } : ev));
                        setProcessingImage(false);
                    };
                };
            };

            const handleCoverUpload = (id, e) => {
                const file = e.target.files[0];
                if (!file) return;
                setProcessingImage(true);
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const MAX_WIDTH = 800; const MAX_HEIGHT = 800;
                        let width = img.width; let height = img.height;
                        if (width > height) { if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; } }
                        else { if (height > MAX_HEIGHT) { width *= MAX_HEIGHT / height; height = MAX_HEIGHT; } }
                        canvas.width = width; canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        const compressedBase64 = canvas.toDataURL('image/jpeg', 0.7);
                        setEvents(prev => prev.map(ev => ev.id === id ? { ...ev, imageUrl: compressedBase64 } : ev));
                        setProcessingImage(false);
                    };
                };
            };

            // DnD Logic
            const handleDragStart = (e, id) => { if (searchQuery) return; setDraggedEventId(id); e.dataTransfer.effectAllowed = "move"; };
            const handleDragOver = (e, id) => { e.preventDefault(); if (id !== draggedEventId && id !== dragOverId) setDragOverId(id); };
            const handleDragEnd = () => { setDraggedEventId(null); setDragOverId(null); };
            const handleDrop = (e, targetId) => {
                e.preventDefault(); setDragOverId(null);
                if (draggedEventId === targetId || searchQuery) { setDraggedEventId(null); return; }
                const currentList = events.filter(e => e.date === selectedDate);
                const fromIndex = currentList.findIndex(e => e.id === draggedEventId);
                const toIndex = currentList.findIndex(e => e.id === targetId);
                if (fromIndex === -1 || toIndex === -1) { setDraggedEventId(null); return; }
                const newList = [...currentList];
                const [moved] = newList.splice(fromIndex, 1);
                newList.splice(toIndex, 0, moved);
                const otherDaysEvents = events.filter(e => e.date !== selectedDate);
                setEvents([...otherDaysEvents, ...newList]);
                setDraggedEventId(null);
                setDroppedId(draggedEventId);
                setTimeout(() => setDroppedId(null), 600);
            };

            // Add Event Logic
            const handleAddEvent = (indexToInsert = -1) => {
                const newId = `new-${Date.now()}`;
                let smartTime = "12:00";
                const currentDayEvents = events.filter(e => e.date === selectedDate).sort((a, b) => a.time.localeCompare(b.time));

                if (currentDayEvents.length > 0) {
                    if (indexToInsert === 0) {
                        const [h, m] = currentDayEvents[0].time.split(':').map(Number);
                        const newH = Math.max(0, h - 1);
                        smartTime = `${newH.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
                    } else if (indexToInsert >= currentDayEvents.length) {
                        const [h, m] = currentDayEvents[currentDayEvents.length - 1].time.split(':').map(Number);
                        const newH = Math.min(23, h + 1);
                        smartTime = `${newH.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
                    } else if (indexToInsert > 0) {
                        const [h1, m1] = currentDayEvents[indexToInsert - 1].time.split(':').map(Number);
                        const [h2, m2] = currentDayEvents[indexToInsert].time.split(':').map(Number);
                        const tMid = Math.floor(((h1 * 60 + m1) + (h2 * 60 + m2)) / 2);
                        smartTime = `${Math.floor(tMid / 60).toString().padStart(2, '0')}:${(tMid % 60).toString().padStart(2, '0')}`;
                    }
                } else { smartTime = "09:00"; }

                const newEvent = { id: newId, date: selectedDate, time: smartTime, title: "", type: "activity", location: "", shortDescription: "New Item", isCompleted: false, images: [] };
                setEvents(prev => [...prev, newEvent]);
                setEditingId(newId);
                if (searchQuery) setSearchQuery("");
            };

            const getCategoryIcon = (type) => {
                switch(type) {
                    case 'transport': return <Plane className="text-blue-400" />;
                    case 'food': return <Utensils className="text-orange-400" />;
                    case 'stay': return <Hotel className="text-purple-400" />;
                    case 'activity': return <Camera className="text-emerald-400" />;
                    case 'warning': return <AlertTriangle className="text-red-400" />;
                    case 'party': return <Sun className="text-pink-400" />;
                    default: return <MapPin className="text-slate-400" />;
                }
            };

            const typeLabels = { transport: "‰∫§ÈÄö", activity: "Ë°åÁ®ã", food: "ÁæéÈ£ü", stay: "‰ΩèÂÆø", warning: "Ê≥®ÊÑè", party: "Ê¥æÂ∞ç" };

            const AddZone = ({ index }) => (
                <div className="h-2 w-full flex items-center justify-center cursor-pointer group my-1 relative z-10" onClick={() => handleAddEvent(index)}>
                    <div className="w-full h-px bg-slate-800 group-hover:bg-blue-500/50 transition-colors relative"></div>
                    <div className="absolute bg-slate-900 border border-blue-500/50 text-blue-400 text-[10px] px-3 py-1 rounded-full opacity-0 group-hover:opacity-100 transition-all transform scale-90 group-hover:scale-100 flex items-center gap-1 shadow-lg shadow-blue-900/20">
                        <Plus size={12} /> Insert
                    </div>
                </div>
            );

            return (
                <div className="flex flex-col h-full bg-slate-950 text-slate-50 font-sans">
                    <header className="shrink-0 bg-slate-950/80 backdrop-blur border-b border-slate-800 p-4 pb-0 z-20 transition-all sticky top-0">
                        <div className="flex justify-between items-center mb-3">
                            <div>
                                <div className="text-[10px] tracking-widest text-slate-400 font-bold uppercase">Water Boys Trip 2025</div>
                                <h1 className="text-lg font-bold">Thailand <span style={{color:PRIMARY_COLOR}}>Phuket Trip</span></h1>
                            </div>
                            <div className="text-right flex flex-col items-end">
                                <div className="bg-blue-900/30 border border-blue-500/30 text-blue-300 text-[10px] px-2 py-1 rounded-full mb-1 font-bold">üêò {countdownText}</div>
                                <div className={`text-[10px] text-emerald-500 flex items-center gap-1 transition-opacity duration-500 ${isSaved ? "opacity-100" : "opacity-0"}`}><Cloud size={12} /> Saved</div>
                            </div>
                        </div>

                        {/* View Toggle */}
                        <div className="flex gap-2 mb-3">
                            <button onClick={() => setView('itinerary')} className={`flex-1 flex items-center justify-center gap-2 py-2 rounded-lg text-xs font-bold transition-all ${view === 'itinerary' ? 'bg-slate-800 text-white border border-slate-700' : 'text-slate-500 hover:text-slate-300'}`}>
                                <MapPin size={14} /> Itinerary
                            </button>
                            <button onClick={() => setView('docs')} className={`flex-1 flex items-center justify-center gap-2 py-2 rounded-lg text-xs font-bold transition-all ${view === 'docs' ? 'bg-emerald-900/40 text-emerald-300 border border-emerald-500/30' : 'text-slate-500 hover:text-slate-300'}`}>
                                <FileText size={14} /> Travel Docs
                            </button>
                        </div>

                        {view === 'itinerary' && (
                            <>
                                <div className="flex gap-2 overflow-x-auto pb-3 hide-scrollbar mb-1">
                                    {DATE_TABS.map(d => (
                                        <button key={d.iso} onClick={() => setSelectedDate(d.iso)} className={`shrink-0 px-4 py-2 rounded-full text-xs font-bold border transition-all ${selectedDate === d.iso ? "text-slate-950 border-transparent scale-105" : "border-slate-800 text-slate-400"}`} style={{background: selectedDate === d.iso ? `linear-gradient(135deg, ${PRIMARY_COLOR}, ${PRIMARY_COLOR}dd)` : 'rgba(30,41,59,0.5)'}}>
                                            {d.label}
                                        </button>
                                    ))}
                                </div>

                                <div className="relative mb-2">
                                    <div className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500"><Search size={14}/></div>
                                    <input
                                        type="text"
                                        placeholder="Search title, location, notes..."
                                        className="w-full bg-slate-900 border border-slate-700 rounded-lg py-2 pl-9 pr-8 text-xs text-slate-200 placeholder:text-slate-600 focus:outline-none focus:border-blue-500 transition-colors"
                                        value={searchQuery}
                                        onChange={(e) => setSearchQuery(e.target.value)}
                                    />
                                    {searchQuery && (
                                        <button onClick={() => setSearchQuery("")} className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-500 hover:text-slate-300">
                                            <X size={14}/>
                                        </button>
                                    )}
                                </div>
                            </>
                        )}
                    </header>

                    <main className="flex-1 overflow-y-auto p-4 pb-20">
                        {view === 'docs' ? <DocsView /> : (
                            <div className="bg-slate-900/50 border border-slate-800 rounded-2xl p-4 space-y-0 backdrop-blur-sm min-h-[300px]">
                                {eventsForSelectedDate.length === 0 && <div className="text-center py-10"><div className="text-slate-500 mb-2">{searchQuery ? "No matches found." : "No events today. ü••"}</div>{!searchQuery && <button onClick={() => handleAddEvent(-1)} className="text-xs bg-slate-800 hover:bg-slate-700 px-3 py-1.5 rounded-lg text-slate-300 transition-colors">+ Add First Event</button>}</div>}

                                {!searchQuery && eventsForSelectedDate.length > 0 && <AddZone index={0} />}

                                {eventsForSelectedDate.map((ev, i) => {
                                    const eventDateTime = new Date(`${ev.date}T${ev.time}`);
                                    // 1 Hour buffer for "current" status (e.g., event starts at 10:00, it stays "current" until 11:00)
                                    // But strict past for greying out: if it is strictly past now, it is past.
                                    const isPast = eventDateTime < now;
                                    const isCurrent = eventDateTime.getTime() - now.getTime() < 3600000 && eventDateTime.getTime() > now.getTime();
                                    
                                    const isExpanded = expandedEventId === ev.id;
                                    const isChecked = ev.isCompleted;
                                    const isDragging = draggedEventId === ev.id;
                                    const isEditing = editingId === ev.id;
                                    const isDragOver = dragOverId === ev.id;
                                    const isJustDropped = droppedId === ev.id;

                                    return (
                                        <React.Fragment key={ev.id}>
                                            <div
                                                className={`flex gap-0 group relative transition-opacity duration-200 no-select ${isDragging ? "is-dragging rounded-xl overflow-hidden" : ""} ${isDragOver ? "drag-over-target" : ""} ${isJustDropped ? "pop-success" : ""}`}
                                                draggable={!isEditing && !searchQuery}
                                                onDragStart={(e) => handleDragStart(e, ev.id)}
                                                onDragOver={(e) => handleDragOver(e, ev.id)}
                                                onDragEnd={handleDragEnd}
                                                onDrop={(e) => handleDrop(e, ev.id)}
                                            >
                                                <div className={`w-12 bg-slate-900 border-r border-slate-800 flex items-center justify-center shrink-0 rounded-l-xl ${searchQuery ? "opacity-30 cursor-not-allowed" : "cursor-grab active:cursor-grabbing group-hover:bg-slate-800 transition-colors"}`}>
                                                    <GripVertical size={20} className="text-slate-500 group-hover:text-slate-300 transition-colors" />
                                                </div>

                                                <div className={`flex-1 border-y border-r border-slate-700 bg-slate-900/80 rounded-r-xl overflow-hidden transition-all relative flex flex-col ${isChecked || isPast ? "opacity-50 grayscale" : ""} ${isCurrent ? `ring-1 ring-[${PRIMARY_COLOR}] shadow-lg z-10 !opacity-100 !grayscale-0` : ""}`} onClick={() => !isEditing && setExpandedEventId(isExpanded ? null : ev.id)}>

                                                    <div className="flex flex-row relative">
                                                        {/* Thumbnail - Left Side with Fallback and Upload */}
                                                        <div className={`w-16 shrink-0 relative bg-slate-800 group/thumb ${isEditing ? 'hidden' : 'block'}`}>
                                                            <img
                                                                src={ev.imageUrl || DEFAULT_IMAGE}
                                                                onError={(e) => { e.target.onerror = null; e.target.src = DEFAULT_IMAGE; }}
                                                                className="absolute inset-0 w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity"
                                                                alt=""
                                                            />
                                                            <div className="absolute inset-0 bg-gradient-to-r from-black/20 to-transparent"></div>
                                                            {/* Upload Overlay */}
                                                            <label
                                                                className="absolute inset-0 flex items-center justify-center bg-black/40 opacity-0 group-hover/thumb:opacity-100 transition-opacity cursor-pointer"
                                                                onClick={(e) => e.stopPropagation()}
                                                                title="Change Cover Image"
                                                            >
                                                                <Camera size={20} className="text-white drop-shadow-md" />
                                                                <input
                                                                    type="file"
                                                                    accept="image/*"
                                                                    className="hidden"
                                                                    onChange={(e) => handleCoverUpload(ev.id, e)}
                                                                />
                                                            </label>
                                                        </div>

                                                        {/* Content Section */}
                                                        <div className="flex-1 p-3 pr-14 flex flex-col justify-center min-w-0">
                                                            <div className="flex justify-between items-start gap-3">
                                                                <div className="min-w-0 flex-1">
                                                                    <div className="flex items-center gap-2 mb-1">
                                                                        {isEditing ? <input type="time" className="text-xs bg-slate-800 text-white border border-blue-500/50 rounded px-1 py-0 outline-none" value={ev.time} onClick={(e) => e.stopPropagation()} onChange={(e) => handleUpdateField(ev.id, 'time', e.target.value)} /> : <span className={`font-mono text-xs cursor-pointer hover:text-blue-400 hover:underline decoration-dashed transition-colors ${isCurrent ? `text-[${PRIMARY_COLOR}] font-bold` : "text-slate-400"}`} onClick={(e) => { e.stopPropagation(); setEditingId(ev.id); }} title="Click to Edit">{ev.time}</span>}
                                                                        {isEditing ? (
                                                                            <select className="text-[10px] bg-slate-800 border border-blue-500/50 rounded px-1 py-0 outline-none text-slate-300 ml-2" value={ev.type} onClick={(e) => e.stopPropagation()} onChange={(e) => handleUpdateField(ev.id, 'type', e.target.value)}>
                                                                                <option value="transport">‰∫§ÈÄö</option>
                                                                                <option value="activity">Ë°åÁ®ã</option>
                                                                                <option value="food">ÁæéÈ£ü</option>
                                                                                <option value="stay">‰ΩèÂÆø</option>
                                                                                <option value="party">Ê¥æÂ∞ç</option>
                                                                                <option value="warning">Ê≥®ÊÑè</option>
                                                                            </select>
                                                                        ) : (
                                                                            <span className="text-[10px] px-1.5 rounded border border-slate-700 text-slate-400 ml-2">{typeLabels[ev.type] || ev.type}</span>
                                                                        )}
                                                                    </div>

                                                                    {isEditing ? (
                                                                        <div className="flex items-center gap-2 mt-1" onClick={e => e.stopPropagation()}>
                                                                            <input type="text" className="bg-slate-800 border border-blue-500/50 rounded px-2 py-1 text-sm font-bold text-white w-full outline-none focus:ring-1 focus:ring-blue-500" value={ev.title} placeholder="Event Title..." autoFocus onChange={(e) => handleUpdateField(ev.id, 'title', e.target.value)} onKeyDown={(e) => e.key === 'Enter' && setEditingId(null)} />
                                                                            <button onClick={() => setEditingId(null)} className="bg-emerald-600/20 text-emerald-500 border border-emerald-600/50 p-1 rounded hover:bg-emerald-600 hover:text-white transition-colors"><Check size={16} /></button>
                                                                        </div>
                                                                    ) : (
                                                                        <h3 className="font-semibold flex items-start gap-2 text-slate-100 mt-1">
                                                                            <span className="opacity-90 shrink-0 mt-0.5">{getCategoryIcon(ev.type)}</span>
                                                                            <span className="block break-words leading-tight" onClick={(e) => { e.stopPropagation(); setEditingId(ev.id); }}>
                                                                                <HighlightText text={ev.title} highlight={searchQuery} />
                                                                            </span>
                                                                            <button onClick={(e) => { e.stopPropagation(); setEditingId(ev.id); }} className="opacity-0 group-hover:opacity-50 hover:!opacity-100 text-slate-500 transition-opacity ml-1 shrink-0 mt-0.5"><Edit2 size={12} /></button>
                                                                        </h3>
                                                                    )}

                                                                    <div className="flex items-center gap-2 mt-1.5 min-w-0">
                                                                        {isEditing ? (
                                                                            <div className="flex items-center gap-1 w-full" onClick={e => e.stopPropagation()}>
                                                                                <MapPin size={12} className="text-slate-500 shrink-0" />
                                                                                <input type="text" className="bg-slate-800 text-xs border border-blue-500/50 rounded px-1 py-0.5 text-slate-300 w-full outline-none focus:ring-1 focus:ring-blue-500" value={ev.location || ""} placeholder="Enter location for map..." onChange={(e) => handleUpdateField(ev.id, 'location', e.target.value)} />
                                                                            </div>
                                                                        ) : (
                                                                            ev.location && (
                                                                                <>
                                                                                    <div className="flex items-center gap-1 min-w-0 overflow-hidden">
                                                                                        <MapPin size={12} className="text-slate-400 shrink-0"/>
                                                                                        <span className="text-xs text-slate-400 truncate"><HighlightText text={ev.location} highlight={searchQuery} /></span>
                                                                                    </div>
                                                                                    <button onClick={(e) => { e.stopPropagation(); handleOpenMap(ev.location, ev.title); }} className="text-blue-400 hover:text-blue-300 p-1 shrink-0 active:scale-95 transition-transform ml-1" title="Navigate with Google Maps"><MapIcon size={14} /></button>
                                                                                </>
                                                                            )
                                                                        )}
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            {!isEditing && <p className="text-xs text-slate-300 mt-2 line-clamp-2"><HighlightText text={ev.shortDescription} highlight={searchQuery} /></p>}
                                                            <div className="absolute top-3 right-3 flex flex-col gap-2" onClick={e => e.stopPropagation()}>
                                                                <button onClick={() => handleToggleChecked(ev.id)} className={`w-8 h-8 rounded-full border flex items-center justify-center shrink-0 transition-all ${isChecked ? "bg-emerald-500/20 border-emerald-500 text-emerald-500" : "border-slate-700 text-slate-600 hover:bg-slate-800"}`}>{isChecked && "‚úì"}</button>
                                                                <button onClick={() => handleDeleteEvent(ev.id)} className="w-8 h-8 rounded-full border border-slate-700 text-slate-500 flex items-center justify-center hover:bg-red-500/20 hover:border-red-500 hover:text-red-500 transition-all"><Trash2 size={14} /></button>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    {isExpanded && !isEditing && (
                                                        <div className="bg-slate-950/50 border-t border-slate-800 p-3 space-y-3 animate-in slide-in-from-top-2">
                                                            <textarea onClick={e=>e.stopPropagation()} value={ev.userNotes || ""} onChange={e=> handleNoteChange(ev.id, e.target.value)} className="w-full bg-slate-900 border border-slate-700 rounded-lg text-xs p-2 text-slate-200 focus:outline-none focus:border-[color:#3D9FBD]" placeholder="Notes..." rows={2}></textarea>

                                                            {searchQuery && ev.userNotes && ev.userNotes.toLowerCase().includes(searchQuery.toLowerCase()) && (
                                                                <div className="text-xs p-2 bg-yellow-900/30 border border-yellow-700/50 rounded text-slate-300 mb-2">
                                                                    Match in notes: "...<HighlightText text={ev.userNotes} highlight={searchQuery}/>..."
                                                                </div>
                                                            )}

                                                            <div className="relative group/cover">
                                                                <img
                                                                    src={ev.imageUrl || DEFAULT_IMAGE}
                                                                    onError={(e) => { e.target.onerror = null; e.target.src = DEFAULT_IMAGE; }}
                                                                    className="w-full h-32 object-cover rounded-lg border border-slate-700"
                                                                    alt="Event visual"
                                                                />
                                                                <label
                                                                    className="absolute inset-0 flex items-center justify-center bg-black/40 opacity-0 group-hover/cover:opacity-100 transition-opacity cursor-pointer rounded-lg"
                                                                    onClick={(e) => e.stopPropagation()}
                                                                >
                                                                    <span className="flex items-center gap-2 text-white font-bold text-sm bg-black/50 px-3 py-1.5 rounded-full backdrop-blur-sm"><Camera size={14}/> Change Cover</span>
                                                                    <input type="file" accept="image/*" className="hidden" onChange={(e) => handleCoverUpload(ev.id, e)}/>
                                                                </label>
                                                            </div>

                                                            {ev.images?.map((src,k)=><img key={k} src={src} className="w-full h-24 object-cover rounded-lg border border-slate-700" alt={`Upload ${k}`} />)}

                                                            <label onClick={e=>e.stopPropagation()} className="block w-full py-2 border border-dashed border-slate-600 rounded-lg text-center text-xs text-slate-400 cursor-pointer hover:bg-slate-800">
                                                                <span className="flex items-center justify-center gap-2"><ImageIcon size={14}/> {processingImage ? "Compressing..." : "Add Photo"}</span>
                                                                <input type="file" accept="image/*" className="hidden" onChange={(e) => handleImageUpload(ev.id, e)}/>
                                                            </label>

                                                            <div className="flex justify-center"><ChevronUp size={16} className="text-slate-600 cursor-pointer" onClick={() => setExpandedEventId(null)}/></div>
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                            {!searchQuery && <AddZone index={i + 1} />}
                                        </React.Fragment>
                                    );
                                })}
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<PhuketTripApp />);
    </script>
</body>
</html>